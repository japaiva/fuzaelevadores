{% extends 'producao/base_producao.html' %}
{% load formato_br %}

{% block title %}Relatório de Produtos | Portal Produção{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-gradient-info text-white d-flex justify-content-between align-items-center">
    <div>
      <h5 class="card-title mb-0">
        <i class="fas fa-chart-bar me-2"></i> Relatório de Produtos
      </h5>
    </div>
    <div>
      {% if produtos %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'export' %}{{ key }}={{ value }}&{% endif %}{% endfor %}export=excel" 
           class="btn btn-success btn-sm me-2"
           title="Exportar para Excel">
          <i class="fas fa-file-excel me-1"></i> Exportar Excel
        </a>
      {% endif %}
      <a href="{% url 'producao:dashboard' %}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>
  
  <!-- FILTROS AVANÇADOS -->
  <div class="card-header bg-white">
    <form method="get" id="filtros-form">
      <div class="row g-3">
        
        <!-- Linha 1: Filtros principais -->
        <div class="col-md-2">
          <label class="form-label small fw-bold">Tipo de Produto</label>
          <select name="tipo_produto" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Todos os Tipos</option>
            <option value="MP" {% if tipo_produto_filtro == 'MP' %}selected{% endif %}>Matéria Prima</option>
            <option value="PI" {% if tipo_produto_filtro == 'PI' %}selected{% endif %}>Produto Intermediário</option>
            <option value="PA" {% if tipo_produto_filtro == 'PA' %}selected{% endif %}>Produto Acabado</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold">Grupo</label>
          <select name="grupo" class="form-select form-select-sm" id="filtro-grupo" onchange="updateSubgruposRelatorio()">
            <option value="">Todos os Grupos</option>
            {% for grupo in grupos %}
              <option value="{{ grupo.id }}" {% if grupo_filtro == grupo.id|stringformat:"s" %}selected{% endif %}>
                {{ grupo.codigo }} - {{ grupo.nome|truncatechars:20 }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold">Subgrupo</label>
          <select name="subgrupo" class="form-select form-select-sm" id="filtro-subgrupo" onchange="this.form.submit()">
            <option value="">Todos os Subgrupos</option>
            {% for subgrupo in subgrupos %}
              <option value="{{ subgrupo.id }}" {% if subgrupo_filtro == subgrupo.id|stringformat:"s" %}selected{% endif %}>
                {{ subgrupo.codigo_completo }} - {{ subgrupo.nome|truncatechars:15 }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold">Tipo PI</label>
          <select name="tipo_pi" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Todos os Tipos PI</option>
            {% for value, label in tipo_pi_choices %}
              <option value="{{ value }}" {% if tipo_pi_filtro == value %}selected{% endif %}>
                {{ label|truncatechars:15 }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label small fw-bold">Buscar</label>
          <div class="input-group input-group-sm">
            <input type="text" name="q" class="form-control" 
                   placeholder="Código, nome ou descrição..." 
                   value="{{ query_filtro|default:'' }}">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Linha 2: Filtros de status -->
      <div class="row g-3 mt-2">
        <div class="col-md-2">
          <label class="form-label small fw-bold">Status</label>
          <select name="status_ativo" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Todos</option>
            <option value="sim" {% if status_ativo_filtro == 'sim' %}selected{% endif %}>Ativo</option>
            <option value="nao" {% if status_ativo_filtro == 'nao' %}selected{% endif %}>Inativo</option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small fw-bold">Utilizado</label>
          <select name="utilizado" class="form-select form-select-sm" onchange="this.form.submit()">
            <option value="">Todos</option>
            <option value="sim" {% if utilizado_filtro == 'sim' %}selected{% endif %}>Sim</option>
            <option value="nao" {% if utilizado_filtro == 'nao' %}selected{% endif %}>Não</option>
          </select>
        </div>
        
        
        <div class="col-md-6 d-flex align-items-end">
          <a href="{% url 'producao:relatorio_produtos_completo' %}" class="btn btn-outline-secondary btn-sm me-2">
            <i class="fas fa-times me-1"></i> Limpar Filtros
          </a>
          
          <div class="ms-auto">
            <small class="text-muted">
              <strong>{{ total_produtos }}</strong> produto(s) encontrado(s)
            </small>
          </div>
        </div>
      </div>
    </form>
  </div>
  
  <!-- RESUMO DOS FILTROS APLICADOS -->
  {% if filtros %}
  <div class="card-header bg-light border-top">
    <div class="d-flex align-items-center">
      <span class="badge bg-info me-2">
        <i class="fas fa-filter me-1"></i> Filtros Aplicados
      </span>
      <div class="d-flex flex-wrap gap-1">
        {% if filtros.tipo_produto %}
          <span class="badge bg-primary">Tipo: {{ filtros.tipo_produto }}</span>
        {% endif %}
        {% if filtros.grupo %}
          <span class="badge bg-warning text-dark">Grupo</span>
        {% endif %}
        {% if filtros.subgrupo %}
          <span class="badge bg-warning text-dark">Subgrupo</span>
        {% endif %}
        {% if filtros.tipo_pi %}
          <span class="badge bg-secondary">Tipo PI</span>
        {% endif %}
        {% if filtros.status_ativo %}
          <span class="badge bg-{% if filtros.status_ativo == 'sim' %}success{% else %}danger{% endif %}">
            {% if filtros.status_ativo == 'sim' %}Ativo{% else %}Inativo{% endif %}
          </span>
        {% endif %}
        {% if filtros.utilizado %}
          <span class="badge bg-{% if filtros.utilizado == 'sim' %}warning{% else %}secondary{% endif %} text-dark">
            Utilizado: {% if filtros.utilizado == 'sim' %}Sim{% else %}Não{% endif %}
          </span>
        {% endif %}
        {% if filtros.com_estoque %}
          <span class="badge bg-{% if filtros.com_estoque == 'sim' %}success{% else %}danger{% endif %}">
            Com Estoque: {% if filtros.com_estoque == 'sim' %}Sim{% else %}Não{% endif %}
          </span>
        {% endif %}
        {% if filtros.query %}
          <span class="badge bg-info">Busca: "{{ filtros.query }}"</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- TABELA DE RESULTADOS -->
  <div class="card-body p-0">
    {% if produtos %}
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th style="width: 100px;">Código</th>
              <th style="width: 200px;">Nome</th>
              <th style="width: 60px;">Tipo</th>
              <th style="width: 150px;">Grupo</th>
              <th style="width: 150px;">Subgrupo</th>
              <th style="width: 120px;">Tipo PI</th>
              <th style="width: 90px;" class="text-end">Custo Mat.</th>
              <th style="width: 90px;" class="text-end">Custo Serv.</th>
              <th style="width: 90px;" class="text-end">Custo Total</th>
              <th style="width: 70px;" class="text-center">Util</th>
              <th style="width: 70px;" class="text-center">Sts</th>
            </tr>
          </thead>
          <tbody>
            {% for produto in produtos %}
              <tr>
                <td>
                  <code class="small">{{ produto.codigo }}</code>
                </td>
                
                <td>
                  <div class="fw-semibold">{{ produto.nome|truncatechars:30 }}</div>
                  {% if produto.fornecedor_principal %}
                    <small class="text-muted">{{ produto.fornecedor_principal.nome|truncatechars:25 }}</small>
                  {% endif %}
                </td>
              
                
                <td>
                  <span class="badge {% if produto.tipo == 'MP' %}bg-primary{% elif produto.tipo == 'PI' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                    {{ produto.tipo }}
                  </span>
                </td>
                
                <td>
                  {% if produto.grupo %}
                    <div class="small fw-semibold">{{ produto.grupo.codigo }}</div>
                    <div class="small text-muted">{{ produto.grupo.nome|truncatechars:20 }}</div>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td>
                  {% if produto.subgrupo %}
                    <div class="small fw-semibold">{{ produto.subgrupo.codigo }}</div>
                    <div class="small text-muted">{{ produto.subgrupo.nome|truncatechars:20 }}</div>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td>
                  {% if produto.tipo_pi %}
                    <span class="badge {{ produto.tipo_pi_display_badge }} small">
                      {{ produto.get_tipo_pi_display|truncatechars:12 }}
                    </span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td class="text-end">
                  {% if produto.custo_material %}
                    <span class="text-primary fw-semibold">{{ produto.custo_material|formato_moeda }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td class="text-end">
                  {% if produto.custo_servico %}
                    <span class="text-warning fw-semibold">{{ produto.custo_servico|formato_moeda }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                <td class="text-end">
                  {% if produto.custo_total %}
                    <span class="text-success fw-bold">{{ produto.custo_total|formato_moeda }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                
                
                <td class="text-center">
                  {% if produto.utilizado %}
                    <span class="badge bg-warning text-dark">Sim</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Não</span>
                  {% endif %}
                </td>
                
                <td class="text-center">
                  {% if produto.status == 'ATIVO' %}
                    <span class="badge bg-success">Ativo</span>
                  {% else %}
                    <span class="badge bg-secondary">Inativo</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    
      
    {% else %}
      <!-- ESTADO VAZIO -->
      <div class="text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h6 class="text-muted">Nenhum produto encontrado</h6>
        <p class="text-muted">
          {% if filtros %}
            Nenhum produto corresponde aos filtros aplicados.
          {% else %}
            Nenhum produto está cadastrado no sistema.
          {% endif %}
        </p>
        {% if filtros %}
          <a href="{% url 'producao:relatorio_produtos_completo' %}" class="btn btn-outline-primary">
            <i class="fas fa-times me-1"></i> Limpar Filtros
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bg-gradient-info {
  background: linear-gradient(135deg, #17a2b8, #138496);
}

.table th {
  font-weight: 600;
  font-size: 0.875rem;
  white-space: nowrap;
}

.table td {
  font-size: 0.875rem;
  padding: 0.5rem 0.3rem;
  white-space: nowrap;
}

.table-responsive {
  max-height: 70vh;
}

.sticky-top {
  position: sticky;
  top: 0;
  z-index: 10;
}

.form-select-sm, .form-control {
  font-size: 0.875rem;
}

.badge {
  font-size: 0.75em;
}

.btn-floating {
  position: fixed;
  bottom: 20px;
  right: 20px;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  z-index: 1000;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.btn-floating:hover {
  transform: scale(1.1);
  transition: transform 0.2s ease-in-out;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .table-responsive {
    font-size: 0.8rem;
  }
  
  .btn-floating {
    bottom: 15px;
    right: 15px;
    width: 48px;
    height: 48px;
  }
}

/* Print styles */
@media print {
  .card-header, .btn, .modal, .btn-floating {
    display: none !important;
  }
  
  .table {
    font-size: 0.7rem;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('📊 Inicializando relatório de produtos...');
    
    // Função para atualizar subgrupos baseado no grupo
    window.updateSubgruposRelatorio = function() {
        const grupoSelect = document.getElementById('filtro-grupo');
        const subgrupoSelect = document.getElementById('filtro-subgrupo');
        const grupoId = grupoSelect.value;
        
        // Limpar subgrupos
        subgrupoSelect.innerHTML = '<option value="">Todos os Subgrupos</option>';
        
        if (grupoId) {
            fetch(`/producao/api/subgrupos-relatorio/?grupo_id=${grupoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        data.subgrupos.forEach(subgrupo => {
                            const option = document.createElement('option');
                            option.value = subgrupo.id;
                            option.textContent = `${subgrupo.codigo_completo} - ${subgrupo.nome}`;
                            subgrupoSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Erro ao carregar subgrupos:', error));
        }
        
        // Submeter o formulário após carregar subgrupos
        setTimeout(() => {
            document.getElementById('filtros-form').submit();
        }, 100);
    };
    
    // Atalhos de teclado
    document.addEventListener('keydown', function(e) {
        // Ctrl + E = Exportar Excel
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            const exportBtn = document.querySelector('a[href*="export=excel"]');
            if (exportBtn) {
                exportBtn.click();
            }
        }
        
        // Ctrl + L = Limpar filtros
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            window.location.href = '{% url "producao:relatorio_produtos_completo" %}';
        }
        
        // F1 = Ajuda
        if (e.key === 'F1') {
            e.preventDefault();
            const ajudaModal = new bootstrap.Modal(document.getElementById('ajudaModal'));
            ajudaModal.show();
        }
    });
    
    // Tooltip para atalhos
    const exportBtn = document.querySelector('a[href*="export=excel"]');
    if (exportBtn) {
        exportBtn.title = 'Exportar para Excel (Ctrl+E)';
    }
    
    const limparBtn = document.querySelector('a[href*="relatorio_produtos_completo"]');
    if (limparBtn && limparBtn.textContent.includes('Limpar')) {
        limparBtn.title = 'Limpar Filtros (Ctrl+L)';
    }
    
    // Auto-submit em mudanças de filtro (já implementado nos onchange)
    console.log('✅ Relatório inicializado com sucesso!');
});
</script>
{% endblock %}