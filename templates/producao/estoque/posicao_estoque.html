{% extends 'producao/base_producao.html' %}

{% block title %}Posicao de Estoque | Portal Producao{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-warehouse me-2 text-primary"></i> Posicao de Estoque
    </h5>
    <div>
      <span class="badge bg-primary fs-6 me-2">
        <i class="fas fa-dollar-sign me-1"></i> R$ {{ total_valor|floatformat:2|default:"0,00" }}
      </span>
      <a href="{% url 'producao:dashboard' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>

  <div class="card-header bg-white">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-auto">
        <select name="local" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="">Todos Locais</option>
          {% for local in locais %}
            <option value="{{ local.id }}" {% if request.GET.local == local.id|stringformat:"s" %}selected{% endif %}>
              {{ local.nome }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <select name="tipo_local" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="">Todos Tipos</option>
          <option value="proprio" {% if request.GET.tipo_local == 'proprio' %}selected{% endif %}>Proprio</option>
          <option value="terceiros" {% if request.GET.tipo_local == 'terceiros' %}selected{% endif %}>Em Terceiros</option>
        </select>
      </div>
      <div class="col">
        <input type="text" name="q" class="form-control form-control-sm" placeholder="Buscar produto..." value="{{ request.GET.q }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </form>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Codigo</th>
            <th>Produto</th>
            <th>Local</th>
            <th class="text-center">Tipo</th>
            <th class="text-end">Quantidade</th>
            <th class="text-end">Reservado</th>
            <th class="text-end">Disponivel</th>
            <th class="text-end">Custo Medio</th>
            <th class="text-end">Valor Total</th>
          </tr>
        </thead>
        <tbody>
          {% for est in estoques %}
          <tr>
            <td><strong><code>{{ est.produto.codigo }}</code></strong></td>
            <td>{{ est.produto.nome }}</td>
            <td>{{ est.local_estoque.nome }}</td>
            <td class="text-center">
              {% if est.local_estoque.tipo == 'proprio' %}
                <span class="badge bg-primary">Proprio</span>
              {% else %}
                <span class="badge bg-warning text-dark">Terceiros</span>
              {% endif %}
            </td>
            <td class="text-end">{{ est.quantidade|floatformat:2 }}</td>
            <td class="text-end">
              {% if est.quantidade_reservada %}
                <span class="text-warning">{{ est.quantidade_reservada|floatformat:2 }}</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-end">
              <strong>{{ est.quantidade_disponivel|floatformat:2 }}</strong>
            </td>
            <td class="text-end">R$ {{ est.custo_medio|floatformat:2 }}</td>
            <td class="text-end">R$ {{ est.valor_total|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              Nenhum item em estoque encontrado.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if estoques.paginator.num_pages > 1 %}
  <div class="card-footer bg-white">
    <nav aria-label="Paginacao">
      <ul class="pagination pagination-sm justify-content-center mb-0">
        {% if estoques.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ estoques.previous_page_number }}{% if request.GET.local %}&local={{ request.GET.local }}{% endif %}{% if request.GET.tipo_local %}&tipo_local={{ request.GET.tipo_local }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&laquo;</a>
        </li>
        {% endif %}
        <li class="page-item active">
          <span class="page-link">{{ estoques.number }} / {{ estoques.paginator.num_pages }}</span>
        </li>
        {% if estoques.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ estoques.next_page_number }}{% if request.GET.local %}&local={{ request.GET.local }}{% endif %}{% if request.GET.tipo_local %}&tipo_local={{ request.GET.tipo_local }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&raquo;</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}
