{% extends 'producao/base_producao.html' %}
{% load static %}

{% block title %}Formulas de Calculo | Portal Producao{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
        <h5 class="card-title mb-0">
            <i class="fas fa-calculator me-2"></i>Formulas de Calculo - Dimensionamento
        </h5>
        <div>
            {% if request.GET.origem == 'vendedor' %}
            <a href="{% url 'vendedor:proposta_list' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
            {% else %}
            <a href="{% url 'producao:regras_yaml_list' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Voltar
            </a>
            {% endif %}
        </div>
    </div>

    <div class="card-body">

        <!-- Fluxo Geral -->
        <div class="mb-4">
            <h6 class="border-bottom pb-2 mb-3">Fluxo Geral de Calculo</h6>
            <div class="row">
                <div class="col-12">
                    <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
                        <!-- Step 1 -->
                        <div class="text-center">
                            <div class="bg-primary text-white rounded p-2 px-3" style="min-width: 140px;">
                                <small class="d-block text-white-50">1</small>
                                <strong>Especificacoes</strong>
                            </div>
                            <small class="text-muted d-block mt-1">Po√ßo, porta, capacidade</small>
                        </div>
                        <i class="fas fa-arrow-right text-muted"></i>

                        <!-- Step 2 -->
                        <div class="text-center">
                            <div class="bg-success text-white rounded p-2 px-3" style="min-width: 140px;">
                                <small class="d-block text-white-50">2</small>
                                <strong>Dimensionamento</strong>
                            </div>
                            <small class="text-muted d-block mt-1">Largura, comprimento</small>
                        </div>
                        <i class="fas fa-arrow-right text-muted"></i>

                        <!-- Step 3 -->
                        <div class="text-center">
                            <div class="bg-info text-white rounded p-2 px-3" style="min-width: 140px;">
                                <small class="d-block text-white-50">3</small>
                                <strong>Custos YAML</strong>
                            </div>
                            <small class="text-muted d-block mt-1">Cabine, carrinho, tracao</small>
                        </div>
                        <i class="fas fa-arrow-right text-muted"></i>

                        <!-- Step 4 -->
                        <div class="text-center">
                            <div class="bg-warning text-dark rounded p-2 px-3" style="min-width: 140px;">
                                <small class="d-block text-dark-50">4</small>
                                <strong>Custos Indiretos</strong>
                            </div>
                            <small class="text-muted d-block mt-1">MOD, indiretos, instalacao</small>
                        </div>
                        <i class="fas fa-arrow-right text-muted"></i>

                        <!-- Step 5 -->
                        <div class="text-center">
                            <div class="bg-dark text-white rounded p-2 px-3" style="min-width: 140px;">
                                <small class="d-block text-white-50">5</small>
                                <strong>Preco Final</strong>
                            </div>
                            <small class="text-muted d-block mt-1">Margem, comissao, impostos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <!-- Secao 1: Especificacoes -->
        <div class="mb-4">
            <h5 class="text-primary fw-bold mb-3">
                <span class="badge bg-primary me-2">1</span> Especificacoes (Entrada de Dados)
            </h5>
            <div class="ms-3">
                <p class="mb-2">Dados informados pelo usuario na proposta:</p>
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-muted mb-2">Poco</h6>
                        <ul class="list-unstyled small">
                            <li>Largura do poco (m)</li>
                            <li>Comprimento do poco (m)</li>
                            <li>Saida oposta (sim/nao)</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted mb-2">Portas</h6>
                        <ul class="list-unstyled small">
                            <li>Modelo (Automatica, Pantografica...)</li>
                            <li>Folhas (2, 3, 4)</li>
                            <li>Abertura (Esquerda, Direita, Central)</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted mb-2">Cabine</h6>
                        <ul class="list-unstyled small">
                            <li>Tipo de elevador (Passageiro, Carga)</li>
                            <li>Capacidade (pessoas ou kg)</li>
                            <li>Posicao do contrapeso</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <!-- Secao 2: Dimensionamento -->
        <div class="mb-4">
            <h5 class="text-success fw-bold mb-3">
                <span class="badge bg-success me-2">2</span> Dimensionamento
            </h5>
        </div>

        <!-- 2.1 Calculo da Largura -->
        <div class="mb-4 ms-3">
            <h6 class="border-bottom pb-2 mb-3">2.1 Calculo da LARGURA da Cabine</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-secondary py-2">
                        <code>Largura = Largura_Poco - Subtracao - Contrapeso_Lateral</code>
                    </div>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Condicao</th><th>Subtracao</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Largura do Poco &le; 1.50m</td><td><strong>0.42m</strong></td></tr>
                            <tr><td>Largura do Poco > 1.50m</td><td><strong>0.48m</strong></td></tr>
                            <tr><td>Contrapeso Lateral</td><td><strong>- 0.23m</strong> (adicional)</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info py-2">
                        <strong>Exemplo:</strong> Poco 1.80m, Contrapeso Lateral<br>
                        Largura = 1.80 - 0.48 - 0.23 = <strong>1.09m</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2.2 Calculo do Comprimento -->
        <div class="mb-4 ms-3">
            <h6 class="border-bottom pb-2 mb-3">2.2 Calculo do COMPRIMENTO da Cabine</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-secondary py-2">
                        <code>Comprimento = Comprimento_Poco - 0.10m - Ajuste_Porta - Contrapeso_Traseiro</code>
                    </div>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Modelo da Porta</th><th>Ajuste</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Automatica - Abertura Central</td><td><strong>0.138m</strong></td><td><span class="badge bg-success">OK</span></td></tr>
                            <tr><td>Automatica - 2 Folhas</td><td><strong>0.21m</strong></td><td><span class="badge bg-success">OK</span></td></tr>
                            <tr><td>Automatica - 3 Folhas</td><td><strong>0.31m</strong></td><td><span class="badge bg-success">OK</span></td></tr>
                            <tr class="table-warning"><td>Automatica - 4 Folhas</td><td><strong>???</strong></td><td><span class="badge bg-danger">NAO DEFINIDO</span></td></tr>
                            <tr><td>Pantografica</td><td><strong>0.13m</strong></td><td><span class="badge bg-success">OK</span></td></tr>
                            <tr><td>Pivotante</td><td><strong>0.04m</strong></td><td><span class="badge bg-success">OK</span></td></tr>
                            <tr class="table-warning"><td>Guilhotina</td><td><strong>???</strong></td><td><span class="badge bg-danger">NAO DEFINIDO</span></td></tr>
                            <tr class="table-warning"><td>Camarao</td><td><strong>???</strong></td><td><span class="badge bg-danger">NAO DEFINIDO</span></td></tr>
                            <tr class="table-warning"><td>Cancela</td><td><strong>???</strong></td><td><span class="badge bg-danger">NAO DEFINIDO</span></td></tr>
                            <tr class="table-warning"><td>Rampa</td><td><strong>???</strong></td><td><span class="badge bg-danger">NAO DEFINIDO</span></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm table-bordered mb-3">
                        <thead class="table-light">
                            <tr><th>Condicao</th><th>Acao</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Saida Oposta</td><td>Ajuste da Porta <strong>x 2</strong></td></tr>
                            <tr><td>Contrapeso Traseiro</td><td><strong>- 0.23m</strong> (adicional)</td></tr>
                        </tbody>
                    </table>
                    <div class="alert alert-info py-2">
                        <strong>Exemplo:</strong> Poco 2.00m, Automatica 2 Folhas, Contrapeso Traseiro<br>
                        Comprimento = 2.00 - 0.10 - 0.21 - 0.23 = <strong>1.46m</strong>
                    </div>
                    <div class="alert alert-warning py-2">
                        <strong>Atencao:</strong> Se o tipo de porta nao estiver definido, o ajuste sera <strong>0</strong>, resultando em calculo incorreto!
                    </div>
                </div>
            </div>
        </div>

        <!-- 2.3 Capacidade e Tracao -->
        <div class="mb-4 ms-3">
            <h6 class="border-bottom pb-2 mb-3">2.3 Calculo de CAPACIDADE e TRACAO</h6>
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Tipo de Elevador</th><th>Formula</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Passageiro</td><td><code>Capacidade = Pessoas x <strong>80 kg</strong></code></td></tr>
                            <tr><td>Carga / Monta-Carga</td><td><code>Capacidade = Valor informado</code></td></tr>
                        </tbody>
                    </table>
                    <div class="alert alert-secondary py-2">
                        <code>Tracao = (Capacidade / 2) + <strong>500 kg</strong></code>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info py-2">
                        <strong>Exemplo Passageiro:</strong> 10 pessoas<br>
                        Capacidade = 10 x 80 = <strong>800 kg</strong><br>
                        Tracao = (800 / 2) + 500 = <strong>900 kg</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2.4 Chapas -->
        <div class="mb-4 ms-3">
            <h6 class="border-bottom pb-2 mb-3">2.4 Calculo de CHAPAS e PAINEIS</h6>
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm table-bordered">
                        <tbody>
                            <tr><td>Dimensoes da Chapa Padrao</td><td><strong>1.20m x 3.00m</strong></td></tr>
                            <tr><td>Largura ideal do painel</td><td><strong>0.25m a 0.33m</strong></td></tr>
                            <tr><td>Dobras</td><td><strong>+ 0.085m</strong> (8.5cm)</td></tr>
                            <tr><td>Maximo com dobras</td><td><strong>0.40m</strong></td></tr>
                            <tr><td>Chapas de margem/reserva</td><td><strong>2 chapas</strong></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-secondary py-2">
                        <strong>Total Chapas = </strong>Chapas Laterais/Teto + Chapas Fundo + 2 (margem)
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <!-- Secao 3: Custos YAML -->
        <div class="mb-4">
            <h5 class="text-info fw-bold mb-3">
                <span class="badge bg-info me-2">3</span> Custos YAML (Regras de Composicao)
            </h5>
            <div class="ms-3">
                <p class="mb-2">Os custos de materiais sao calculados atraves das <strong>Regras de Composicao de Preco</strong> em formato YAML:</p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item py-1"><strong>CABINE</strong> - Chapas, portas, acabamentos</li>
                            <li class="list-group-item py-1"><strong>CARRINHO</strong> - Estrutura, guias, amortecedores</li>
                            <li class="list-group-item py-1"><strong>TRACAO</strong> - Motor, cabos, maquina</li>
                            <li class="list-group-item py-1"><strong>SISTEMAS</strong> - Eletrica, quadro, botoeiras</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info py-2">
                            <a href="{% url 'producao:regras_yaml_list' %}" class="text-decoration-none">
                                <i class="fas fa-external-link-alt me-1"></i>
                                Gerenciar Regras de Composicao de Preco
                            </a>
                        </div>
                    </div>
                </div>

                {% if regras_com_erro %}
                <!-- Erros de Validacao YAML -->
                <div class="mt-3">
                    <h6 class="text-danger mb-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Codigos de Produtos Nao Encontrados
                    </h6>
                    {% for regra in regras_com_erro %}
                    <div class="card border-danger mb-2">
                        <div class="card-header py-1 bg-danger bg-opacity-10 d-flex justify-content-between align-items-center">
                            <span>
                                <strong>{{ regra.tipo }}</strong> - {{ regra.nome }}
                            </span>
                            {% if not regra.ativa %}
                            <span class="badge bg-secondary">Inativa</span>
                            {% endif %}
                        </div>
                        <div class="card-body py-2">
                            <ul class="mb-0 small">
                            {% for item in regra.codigos %}
                                <li>
                                    <code class="text-danger">{{ item.codigo }}</code>
                                    {% if item.contexto %}<span class="text-muted"> - {{ item.contexto }}</span>{% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="mt-3">
                    <div class="alert alert-success py-2 mb-0">
                        <i class="fas fa-check-circle me-1"></i>
                        Todas as regras YAML estao validadas - nenhum codigo de produto faltando.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <hr>

        <!-- Secao 4: Custos Indiretos -->
        <div class="mb-4">
            <h5 class="text-warning fw-bold mb-3">
                <span class="badge bg-warning text-dark me-2">4</span> Custos Indiretos
            </h5>
        </div>
        <div class="mb-4 ms-3">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Parametro</th><th>Valor Atual</th><th>Base</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Mao de Obra</td><td><strong>{{ params.percentual_mao_obra }}%</strong></td><td>Custo Materiais</td></tr>
                            <tr><td>Indiretos Fabricacao</td><td><strong>{{ params.percentual_indiretos_fabricacao }}%</strong></td><td>Custo Materiais</td></tr>
                            <tr><td>Instalacao</td><td><strong>{{ params.percentual_instalacao }}%</strong></td><td>Custo Materiais</td></tr>
                        </tbody>
                    </table>
                    <small class="text-muted">Configuracoes > Parametros Gerais</small>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-secondary py-2">
                        <code>Custo Producao = Materiais + MOD + Indiretos</code><br>
                        <code>Custo Total = Custo Producao + Instalacao</code>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <!-- Secao 5: Formacao de Preco -->
        <div class="mb-4">
            <h5 class="text-dark fw-bold mb-3">
                <span class="badge bg-dark me-2">5</span> Formacao de Preco
            </h5>
        </div>
        <div class="mb-4 ms-3">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Parametro</th><th>Valor Atual</th><th>Base</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Margem de Lucro</td><td><strong>{{ params.margem_padrao }}%</strong></td><td>Custo Total</td></tr>
                            <tr><td>Comissao</td><td><strong>{{ params.comissao_padrao }}%</strong></td><td>Preco com Margem</td></tr>
                            <tr><td>Impostos</td><td><em>Dinamico</em></td><td>Preco com Comissao</td></tr>
                        </tbody>
                    </table>
                    <small class="text-muted">Configuracoes > Parametros Gerais</small>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-secondary py-2">
                        <code>Margem = Custo Total x {{ params.margem_padrao }}%</code><br>
                        <code>Comissao = Preco c/ Margem x {{ params.comissao_padrao }}%</code><br>
                        <code>Preco Final = Preco c/ Comissao + Impostos</code>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}
