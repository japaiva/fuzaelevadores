<!-- templates/producao/produtos/produto_intermediario_form.html -->
{% extends 'producao/base_producao.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Produto Intermedi√°rio | Sistema FUZA{% endblock %}

{% block content %}
<div class="container-fluid">
  
  <!-- ========================================================================= -->
  <!-- DEBUG SECTION - REMOVER EM PRODU√á√ÉO -->
  <!-- ========================================================================= -->
  
  <div class="alert alert-info alert-dismissible">
    <h6><i class="fas fa-bug me-1"></i> DEBUG - Status do Formul√°rio</h6>
    <div class="row small">
      <div class="col-md-3">
        <strong>Modo:</strong> {% if form.instance.pk %}Edi√ß√£o{% else %}Cria√ß√£o{% endif %}
      </div>
      <div class="col-md-3">
        <strong>Produto ID:</strong> {{ form.instance.pk|default:"Novo" }}
      </div>
      <div class="col-md-3">
        <strong>Tipo:</strong> {{ form.instance.tipo|default:"Ser√° PI" }}
      </div>
      <div class="col-md-3">
        <strong>Grupo:</strong> {{ form.instance.grupo.nome|default:"N√£o definido" }}
      </div>
    </div>
    <div class="row small mt-1">
      <div class="col-md-3">
        <strong>Subgrupo:</strong> {{ form.instance.subgrupo.nome|default:"N√£o definido" }}
      </div>
      <div class="col-md-3">
        <strong>Tipo PI:</strong> {{ form.instance.get_tipo_pi_display|default:"N√£o definido" }}
      </div>
      <div class="col-md-3">
        <strong>C√≥digo:</strong> {{ form.instance.codigo|default:"Ser√° gerado" }}
      </div>
      <div class="col-md-3">
        <strong>Form Valid:</strong> <span id="form-valid-status">Verificando...</span>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="card shadow">
    <div class="card-header bg-gradient-warning text-white d-flex justify-content-between align-items-center">
      <div>
        <h5 class="card-title mb-0">
          <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"></i>
          {% if form.instance.pk %}Editar{% else %}Novo{% endif %} Produto Intermedi√°rio
        </h5>
        <small class="opacity-75">
          {% if form.instance.pk %}
            Editando: {{ form.instance.codigo }} | {{ form.instance.nome }}
          {% else %}
            Criando novo produto intermedi√°rio (Tipo = PI)
          {% endif %}
        </small>
      </div>
      <a href="{% url 'producao:produto_intermediario_list' %}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>

    <div class="card-body">
      <form method="post" id="produto-form" novalidate>
        {% csrf_token %}

        <!-- Erros gerais do formul√°rio -->
        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <h6><i class="fas fa-exclamation-triangle me-1"></i> Erros no Formul√°rio:</h6>
            {% for error in form.non_field_errors %}
              <p class="mb-1">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 1: IDENTIFICA√á√ÉO -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-warning border-4 mb-4">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-tag me-2 text-warning"></i>
              1. Identifica√ß√£o
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- C√≥digo (somente leitura se for edi√ß√£o) -->
              <div class="col-md-4">
                <label class="form-label">C√≥digo do Produto</label>
                {% if form.instance.pk %}
                  <div class="form-control-plaintext fw-bold text-warning fs-5">
                    {{ form.instance.codigo }}
                  </div>
                  <small class="text-muted">C√≥digo gerado automaticamente</small>
                {% else %}
                  <div class="form-control-plaintext text-muted">
                    <i class="fas fa-cog fa-spin me-1"></i>
                    Ser√° gerado automaticamente
                  </div>
                  <small class="text-muted">Formato: GG.SS.NNNNN</small>
                {% endif %}
              </div>

              <!-- Nome do produto -->
              <div class="col-md-8">
                <label for="{{ form.nome.id_for_label }}" class="form-label">
                  Nome do Produto Intermedi√°rio <span class="text-danger">*</span>
                </label>
                {{ form.nome }}
                {% if form.nome.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.nome.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small>Nome descritivo do produto intermedi√°rio</small>
                </div>
              </div>
            </div>

            <!-- Descri√ß√£o -->
            <div class="row g-3 mt-2">
              <div class="col-12">
                <label for="{{ form.descricao.id_for_label }}" class="form-label">Descri√ß√£o</label>
                {{ form.descricao }}
                {% if form.descricao.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.descricao.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small>Descri√ß√£o detalhada do produto (opcional)</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 2: CLASSIFICA√á√ÉO (GRUPO/SUBGRUPO) -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-primary border-4 mb-4">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-layer-group me-2 text-primary"></i>
              2. Classifica√ß√£o
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Grupo -->
              <div class="col-md-6">
                <label for="{{ form.grupo.id_for_label }}" class="form-label">
                  Grupo <span class="text-danger">*</span>
                </label>
                {{ form.grupo }}
                {% if form.grupo.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.grupo.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small id="grupo-help">Apenas grupos do tipo PI s√£o exibidos</small>
                </div>
              </div>

              <!-- Subgrupo -->
              <div class="col-md-6">
                <label for="{{ form.subgrupo.id_for_label }}" class="form-label">
                  Subgrupo <span class="text-danger">*</span>
                </label>
                {{ form.subgrupo }}
                {% if form.subgrupo.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.subgrupo.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small id="subgrupo-help">Selecione um grupo primeiro</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 3: TIPO DO PRODUTO INTERMEDI√ÅRIO - SEMPRE VIS√çVEL PARA DEBUG -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-success border-4 mb-4" id="tipo-pi-section">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-cogs me-2 text-success"></i>
              3. Tipo do Produto Intermedi√°rio <span class="text-danger">*</span>
            </h6>
          </div>
          <div class="card-body">
            
            <!-- DEBUG: Status da se√ß√£o -->
            <div class="alert alert-light border mb-3">
              <strong>DEBUG:</strong> 
              <span id="debug-tipo-pi-status">Se√ß√£o carregada</span>
              | <strong>Required:</strong> <span id="debug-tipo-pi-required">Verificando...</span>
              | <strong>Value:</strong> <span id="debug-tipo-pi-value">{{ form.instance.tipo_pi|default:"Vazio" }}</span>
            </div>

            <div class="row g-3">
              <!-- Campo Tipo PI -->
              <div class="col-md-6">
                <label for="{{ form.tipo_pi.id_for_label }}" class="form-label">
                  Selecione o Tipo <span class="text-danger">*</span>
                </label>
                {{ form.tipo_pi }}
                {% if form.tipo_pi.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.tipo_pi.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small>Define como o produto √© obtido/produzido</small>
                </div>
              </div>
              
              <!-- Informa√ß√µes do tipo selecionado -->
              <div class="col-md-6" id="tipo-pi-info">
                <div class="alert alert-light border-0" id="tipo-info-display" style="display: none;">
                  <h6 class="alert-heading mb-2">
                    <i class="fas fa-info-circle me-1"></i> 
                    <span id="tipo-info-title">Informa√ß√µes do Tipo</span>
                  </h6>
                  <p class="mb-1 small" id="tipo-info-description">Selecione um tipo para ver as informa√ß√µes.</p>
                  <div class="mt-2" id="tipo-info-example" style="display: none;">
                    <strong>Exemplo:</strong> <span id="tipo-info-example-text"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Alertas condicionais baseados no tipo -->
            <div class="row g-3 mt-2" id="estrutura-info" style="display: none;">
              <div class="col-12">
                <div class="alert alert-success border-success">
                  <h6 class="alert-heading">
                    <i class="fas fa-sitemap me-1"></i> Estrutura de Componentes Habilitada
                  </h6>
                  <p class="mb-2">
                    Este tipo permite definir estrutura de componentes (Mat√©rias-Primas ou outros Produtos Intermedi√°rios).
                    O custo ser√° calculado automaticamente baseado nos componentes e suas propor√ß√µes.
                  </p>
                  
                  {% if form.instance.pk and form.instance.pode_ter_estrutura %}
                    <div class="d-flex gap-2 mt-3">
                      <a href="{% url 'producao:produto_intermediario_estrutura' form.instance.pk %}" 
                         class="btn btn-outline-success btn-sm">
                        <i class="fas fa-sitemap me-1"></i> Gerenciar Estrutura
                      </a>
                      {% if form.instance.componentes.exists %}
                        <span class="badge bg-info align-self-center">
                          {{ form.instance.componentes.count }} componente(s)
                        </span>
                      {% else %}
                        <span class="badge bg-warning align-self-center">
                          Estrutura n√£o definida
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row g-3 mt-2" id="custo-manual-info" style="display: none;">
              <div class="col-12">
                <div class="alert alert-warning border-warning">
                  <h6 class="alert-heading">
                    <i class="fas fa-hand-paper me-1"></i> Custo Manual Requerido
                  </h6>
                  <p class="mb-0">
                    Para este tipo, o custo deve ser informado manualmente nos campos de pre√ßo abaixo.
                    N√£o √© poss√≠vel calcular automaticamente via estrutura de componentes.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 4: CARACTER√çSTICAS T√âCNICAS -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-info border-4 mb-4">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-wrench me-2 text-info"></i>
              4. Caracter√≠sticas T√©cnicas
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ form.unidade_medida.id_for_label }}" class="form-label">
                  Unidade de Medida <span class="text-danger">*</span>
                </label>
                {{ form.unidade_medida }}
                {% if form.unidade_medida.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.unidade_medida.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ form.peso_unitario.id_for_label }}" class="form-label">Peso Unit√°rio (kg)</label>
                {{ form.peso_unitario }}
                {% if form.peso_unitario.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.peso_unitario.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                {{ form.status }}
                {% if form.status.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.status.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 5: FORNECIMENTO -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-secondary border-4 mb-4">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-truck me-2 text-secondary"></i>
              5. Fornecimento
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="{{ form.fornecedor_principal.id_for_label }}" class="form-label">
                  Fornecedor Principal
                  <span id="fornecedor-obrigatorio" class="text-danger" style="display: none;">*</span>
                </label>
                {{ form.fornecedor_principal }}
                {% if form.fornecedor_principal.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.fornecedor_principal.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small id="fornecedor-help">Fornecedor preferencial (opcional)</small>
                </div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.prazo_entrega_padrao.id_for_label }}" class="form-label">Prazo Entrega (dias)</label>
                {{ form.prazo_entrega_padrao }}
                {% if form.prazo_entrega_padrao.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.prazo_entrega_padrao.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 6: CUSTOS -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-warning border-4 mb-4">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-calculator me-2 text-warning"></i>
              6. Custos e Pre√ßos
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="{{ form.custo_medio.id_for_label }}" class="form-label">
                  Custo M√©dio
                  <span id="custo-medio-obrigatorio" class="text-danger" style="display: none;">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text">R$</span>
                  {{ form.custo_medio }}
                </div>
                {% if form.custo_medio.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.custo_medio.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">
                  <small id="custo-medio-help">Custo unit√°rio do produto</small>
                </div>
              </div>

              <div class="col-md-4">
                <label for="{{ form.custo_industrializacao.id_for_label }}" class="form-label">Custo Industrializa√ß√£o</label>
                <div class="input-group">
                  <span class="input-group-text">R$</span>
                  {{ form.custo_industrializacao }}
                </div>
                {% if form.custo_industrializacao.errors %}
                  <div class="text-danger small mt-1">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    {% for error in form.custo_industrializacao.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label class="form-label">Custo Total</label>
                <div id="custo-total-display" class="form-control-plaintext fw-bold text-primary fs-5">
                  R$ 0,00
                </div>
                <div class="form-text">
                  <small>Custo m√©dio + industrializa√ß√£o</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- SE√á√ÉO 7: CONTROLES -->
        <!-- ===================================================================== -->
        
        <div class="card border-start border-danger border-4 mb-4">
          <div class="card-header bg-light">
            <h6 class="card-title mb-0">
              <i class="fas fa-sliders-h me-2 text-danger"></i>
              7. Controles
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="form-check form-switch">
                  {{ form.controla_estoque }}
                  <label class="form-check-label fw-semibold" for="{{ form.controla_estoque.id_for_label }}">
                    Controla Estoque
                  </label>
                </div>
              </div>

              <div class="col-md-3">
                <div class="form-check form-switch">
                  {{ form.disponivel }}
                  <label class="form-check-label fw-semibold" for="{{ form.disponivel.id_for_label }}">
                    Dispon√≠vel p/ Uso
                  </label>
                </div>
              </div>

              <div class="col-md-3">
                <div class="form-check form-switch">
                  {{ form.utilizado }}
                  <label class="form-check-label fw-semibold" for="{{ form.utilizado.id_for_label }}">
                    Utilizado no Custo
                  </label>
                </div>
              </div>

              <div class="col-md-3">
                <label for="{{ form.estoque_minimo.id_for_label }}" class="form-label">Estoque M√≠nimo</label>
                {{ form.estoque_minimo }}
              </div>
            </div>
          </div>
        </div>

        <!-- ===================================================================== -->
        <!-- BOT√ïES DE A√á√ÉO -->
        <!-- ===================================================================== -->
        
        <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light rounded">
          <div>
            <button type="button" class="btn btn-outline-info btn-sm" onclick="debugFormulario()">
              <i class="fas fa-bug me-1"></i> Debug Form
            </button>
            {% if form.instance.pk %}
              <small class="text-muted ms-3">
                Editando desde: {{ form.instance.atualizado_em|date:"d/m/Y H:i" }}
              </small>
            {% endif %}
          </div>
          <div class="d-flex gap-2">
            <a href="{% url 'producao:produto_intermediario_list' %}" class="btn btn-outline-secondary">
              <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-warning" id="submit-btn">
              <i class="fas fa-save me-1"></i> 
              {% if form.instance.pk %}Atualizar{% else %}Salvar{% endif %} Produto Intermedi√°rio
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bg-gradient-warning {
  background: linear-gradient(135deg, #ffc107, #fd7e14);
}
.border-4 { border-width: 4px !important; }
.form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
.form-switch .form-check-input { width: 2em; margin-left: -2.5em; }
.card:hover { transform: translateY(-2px); transition: transform 0.2s ease-in-out; }
.alert-light { background-color: #f8f9fa; border-color: #dee2e6; }
.text-danger { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    console.log('üöÄ Inicializando formul√°rio com debug completo...');
    
    // =========================================================================
    // ELEMENTOS DO FORMUL√ÅRIO
    // =========================================================================
    
    const tipoPiSelect = document.getElementById('{{ form.tipo_pi.id_for_label }}');
    const grupoSelect = document.getElementById('{{ form.grupo.id_for_label }}');
    const subgrupoSelect = document.getElementById('{{ form.subgrupo.id_for_label }}');
    const fornecedorSelect = document.getElementById('{{ form.fornecedor_principal.id_for_label }}');
    const custoMedioInput = document.getElementById('{{ form.custo_medio.id_for_label }}');
    const custoIndustrializacaoInput = document.getElementById('{{ form.custo_industrializacao.id_for_label }}');
    
    // Elementos de debug
    const debugTipoPiStatus = document.getElementById('debug-tipo-pi-status');
    const debugTipoPiRequired = document.getElementById('debug-tipo-pi-required');
    const debugTipoPiValue = document.getElementById('debug-tipo-pi-value');
    const formValidStatus = document.getElementById('form-valid-status');
    
    // =========================================================================
    // FUN√á√ÉO DE DEBUG GLOBAL
    // =========================================================================
    
    window.debugFormulario = function() {
        console.log('üîß DEBUG FORMUL√ÅRIO:');
        console.log('Grupo selecionado:', grupoSelect ? grupoSelect.value : 'N/A');
        console.log('Subgrupo selecionado:', subgrupoSelect ? subgrupoSelect.value : 'N/A');
        console.log('Tipo PI selecionado:', tipoPiSelect ? tipoPiSelect.value : 'N/A');
        console.log('Tipo PI required:', tipoPiSelect ? tipoPiSelect.required : 'N/A');
        console.log('Tipo PI display:', tipoPiSelect ? tipoPiSelect.style.display : 'N/A');
        console.log('Se√ß√£o tipo-pi-section display:', document.getElementById('tipo-pi-section').style.display);
        
        // Mostrar no alert
        alert(`DEBUG FORMUL√ÅRIO:
Grupo: ${grupoSelect ? grupoSelect.value : 'N/A'}
Subgrupo: ${subgrupoSelect ? subgrupoSelect.value : 'N/A'}
Tipo PI: ${tipoPiSelect ? tipoPiSelect.value : 'N/A'}
Tipo PI Required: ${tipoPiSelect ? tipoPiSelect.required : 'N/A'}
Se√ß√£o Vis√≠vel: ${document.getElementById('tipo-pi-section').style.display !== 'none'}`);
    };
    
    // =========================================================================
    // INFORMA√á√ïES DOS TIPOS DE PI
    // =========================================================================
    
    const tiposInfo = {
        'COMPRADO': {
            title: 'Comprado Pronto',
            description: 'Produto pronto adquirido de fornecedor. Custo deve ser informado manualmente.',
            example: 'Porta cabine pronta, Motor de elevador, Botoeira completa',
            pode_estrutura: false,
            custo_manual: true,
            fornecedor_obrigatorio: true
        },
        'MONTADO_INTERNO': {
            title: 'Montado Internamente',
            description: 'Produto montado na f√°brica com componentes pr√≥prios. Custo calculado automaticamente.',
            example: 'Porta montada com perfis pr√≥prios, Quadro de comando customizado',
            pode_estrutura: true,
            custo_manual: false,
            fornecedor_obrigatorio: false
        },
        'MONTADO_EXTERNO': {
            title: 'Montado Externamente',
            description: 'Produto montado por terceiros. Custo calculado pela estrutura + valor da montagem.',
            example: 'Painel cortado/dobrado, Porta montada por terceiro',
            pode_estrutura: true,
            custo_manual: false,
            fornecedor_obrigatorio: true
        },
        'SERVICO': {
            title: 'Servi√ßo',
            description: 'Presta√ß√£o de servi√ßo interno ou externo. Custo informado manualmente.',
            example: 'M√£o de obra montagem, Servi√ßo de pintura, Transporte',
            pode_estrutura: false,
            custo_manual: true,
            fornecedor_obrigatorio: false
        }
    };
    
    // =========================================================================
    // FUN√á√ÉO: ATUALIZAR DEBUG
    // =========================================================================
    
    function updateDebugInfo() {
        if (debugTipoPiStatus) {
            debugTipoPiStatus.textContent = `Se√ß√£o ${document.getElementById('tipo-pi-section').style.display !== 'none' ? 'VIS√çVEL' : 'OCULTA'}`;
        }
        if (debugTipoPiRequired) {
            debugTipoPiRequired.textContent = tipoPiSelect ? (tipoPiSelect.required ? 'SIM' : 'N√ÉO') : 'N/A';
        }
        if (debugTipoPiValue) {
            debugTipoPiValue.textContent = tipoPiSelect ? (tipoPiSelect.value || 'Vazio') : 'N/A';
        }
        if (formValidStatus) {
            formValidStatus.textContent = 'Atualizado ' + new Date().toLocaleTimeString();
        }
    }
    
    // =========================================================================
    // FUN√á√ÉO: ATUALIZAR INFORMA√á√ïES DO TIPO PI
    // =========================================================================
    
    function updateTipoPiInfo() {
        const tipoSelecionado = tipoPiSelect ? tipoPiSelect.value : '';
        const tipoInfoDisplay = document.getElementById('tipo-info-display');
        const tipoInfoTitle = document.getElementById('tipo-info-title');
        const tipoInfoDescription = document.getElementById('tipo-info-description');
        const tipoInfoExample = document.getElementById('tipo-info-example');
        const tipoInfoExampleText = document.getElementById('tipo-info-example-text');
        const estruturaInfo = document.getElementById('estrutura-info');
        const custoManualInfo = document.getElementById('custo-manual-info');
        
        console.log('üîÑ Atualizando tipo PI:', tipoSelecionado);
        
        if (tipoSelecionado && tiposInfo[tipoSelecionado]) {
            const info = tiposInfo[tipoSelecionado];
            
            // Mostrar informa√ß√µes
            if (tipoInfoDisplay) tipoInfoDisplay.style.display = 'block';
            if (tipoInfoTitle) tipoInfoTitle.textContent = info.title;
            if (tipoInfoDescription) tipoInfoDescription.textContent = info.description;
            if (tipoInfoExampleText) tipoInfoExampleText.textContent = info.example;
            if (tipoInfoExample) tipoInfoExample.style.display = 'block';
            
            // Mostrar/esconder alertas
            if (info.pode_estrutura) {
                if (estruturaInfo) estruturaInfo.style.display = 'block';
                if (custoManualInfo) custoManualInfo.style.display = 'none';
            } else {
                if (estruturaInfo) estruturaInfo.style.display = 'none';
                if (custoManualInfo) custoManualInfo.style.display = 'block';
            }
            
            // Campos obrigat√≥rios condicionais
            const fornecedorObrigatorio = document.getElementById('fornecedor-obrigatorio');
            const custoMedioObrigatorio = document.getElementById('custo-medio-obrigatorio');
            const fornecedorHelp = document.getElementById('fornecedor-help');
            const custoMedioHelp = document.getElementById('custo-medio-help');
            
            if (info.fornecedor_obrigatorio) {
                if (fornecedorObrigatorio) fornecedorObrigatorio.style.display = 'inline';
                if (fornecedorSelect) fornecedorSelect.required = true;
                if (fornecedorHelp) fornecedorHelp.innerHTML = '<small class="text-danger">Obrigat√≥rio para este tipo</small>';
            } else {
                if (fornecedorObrigatorio) fornecedorObrigatorio.style.display = 'none';
                if (fornecedorSelect) fornecedorSelect.required = false;
                if (fornecedorHelp) fornecedorHelp.innerHTML = '<small class="text-muted">Fornecedor preferencial (opcional)</small>';
            }
            
            if (info.custo_manual) {
                if (custoMedioObrigatorio) custoMedioObrigatorio.style.display = 'inline';
                if (custoMedioInput) custoMedioInput.required = true;
                if (custoMedioHelp) custoMedioHelp.innerHTML = '<small class="text-warning">Custo deve ser informado manualmente</small>';
            } else {
                if (custoMedioObrigatorio) custoMedioObrigatorio.style.display = 'none';
                if (custoMedioInput) custoMedioInput.required = false;
                if (custoMedioHelp) custoMedioHelp.innerHTML = '<small class="text-info">Custo pode ser calculado automaticamente</small>';
            }
            
        } else {
            // Esconder tudo
            if (tipoInfoDisplay) tipoInfoDisplay.style.display = 'none';
            if (estruturaInfo) estruturaInfo.style.display = 'none';
            if (custoManualInfo) custoManualInfo.style.display = 'none';
            
            // Resetar campos obrigat√≥rios
            const fornecedorObrigatorio = document.getElementById('fornecedor-obrigatorio');
            const custoMedioObrigatorio = document.getElementById('custo-medio-obrigatorio');
            
            if (fornecedorObrigatorio) fornecedorObrigatorio.style.display = 'none';
            if (custoMedioObrigatorio) custoMedioObrigatorio.style.display = 'none';
            if (fornecedorSelect) fornecedorSelect.required = false;
            if (custoMedioInput) custoMedioInput.required = false;
        }
        
        updateDebugInfo();
    }
    
    // =========================================================================
    // FUN√á√ÉO: ATUALIZAR SUBGRUPOS
    // =========================================================================
    
    function updateSubgrupos(grupoId) {
        console.log('üîÑ Atualizando subgrupos para grupo:', grupoId);
        
        const subgrupoHelp = document.getElementById('subgrupo-help');
        const grupoHelp = document.getElementById('grupo-help');
        
        // Limpar subgrupos
        if (subgrupoSelect) {
            subgrupoSelect.innerHTML = '<option value="">---------</option>';
            if (subgrupoHelp) subgrupoHelp.innerHTML = '<small class="text-muted">Carregando...</small>';
        }
        
        if (grupoId) {
            // Buscar subgrupos
            fetch(`/producao/api/subgrupos/?grupo_id=${grupoId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Subgrupos recebidos:', data);
                    
                    if (data.success && data.subgrupos && subgrupoSelect) {
                        data.subgrupos.forEach(subgrupo => {
                            const option = document.createElement('option');
                            option.value = subgrupo.id;
                            option.textContent = `${subgrupo.codigo_completo} - ${subgrupo.nome}`;
                            subgrupoSelect.appendChild(option);
                        });
                        
                        if (subgrupoHelp) subgrupoHelp.innerHTML = `<small class="text-success">${data.subgrupos.length} subgrupo(s) dispon√≠vel(is)</small>`;
                        
                        // Se √© edi√ß√£o, tentar selecionar o subgrupo atual
                        {% if form.instance.pk and form.instance.subgrupo %}
                        subgrupoSelect.value = '{{ form.instance.subgrupo.id }}';
                        console.log('‚úÖ Subgrupo da edi√ß√£o selecionado:', '{{ form.instance.subgrupo.id }}');
                        {% endif %}
                    } else {
                        if (subgrupoHelp) subgrupoHelp.innerHTML = '<small class="text-warning">Nenhum subgrupo encontrado</small>';
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar subgrupos:', error);
                    if (subgrupoHelp) subgrupoHelp.innerHTML = '<small class="text-danger">Erro ao carregar subgrupos</small>';
                });
            
            // Confirmar que √© grupo PI
            if (grupoHelp) grupoHelp.innerHTML = '<small class="text-success">Grupo PI confirmado</small>';
            
            // Para produtos intermedi√°rios, sempre mostrar tipo_pi (n√£o esconder mais)
            const tipoPiSection = document.getElementById('tipo-pi-section');
            if (tipoPiSection) {
                tipoPiSection.style.display = 'block';
                if (tipoPiSelect) {
                    tipoPiSelect.required = true;
                    console.log('‚úÖ Campo tipo_pi obrigat√≥rio ativado');
                }
            }
            
        } else {
            if (subgrupoHelp) subgrupoHelp.innerHTML = '<small class="text-muted">Selecione um grupo primeiro</small>';
            if (grupoHelp) grupoHelp.innerHTML = '<small class="text-muted">Apenas grupos do tipo PI s√£o exibidos</small>';
            
            // Manter tipo_pi vis√≠vel mesmo sem grupo (para debug)
            const tipoPiSection = document.getElementById('tipo-pi-section');
            if (tipoPiSection) {
                tipoPiSection.style.display = 'block';
                if (tipoPiSelect) tipoPiSelect.required = false;
            }
        }
        
        updateDebugInfo();
    }
    
    // =========================================================================
    // FUN√á√ÉO: CALCULAR CUSTO TOTAL
    // =========================================================================
    
    function calcularCustoTotal() {
        if (custoMedioInput && custoIndustrializacaoInput) {
            const custoMedio = parseFloat(custoMedioInput.value.replace(',', '.')) || 0;
            const custoIndustrializacao = parseFloat(custoIndustrializacaoInput.value.replace(',', '.')) || 0;
            const custoTotal = custoMedio + custoIndustrializacao;
            
            const custoTotalDisplay = document.getElementById('custo-total-display');
            if (custoTotalDisplay) {
                custoTotalDisplay.textContent = 'R$ ' + custoTotal.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                if (custoTotal > 0) {
                    custoTotalDisplay.className = 'form-control-plaintext fw-bold text-success fs-5';
                } else {
                    custoTotalDisplay.className = 'form-control-plaintext fw-bold text-muted fs-5';
                }
            }
        }
    }
    
    // =========================================================================
    // EVENT LISTENERS
    // =========================================================================
    
    // Tipo PI
    if (tipoPiSelect) {
        tipoPiSelect.addEventListener('change', function() {
            console.log('üîÑ Tipo PI alterado para:', this.value);
            updateTipoPiInfo();
        });
    }
    
    // Grupo
    if (grupoSelect) {
        grupoSelect.addEventListener('change', function() {
            console.log('üîÑ Grupo alterado para:', this.value);
            updateSubgrupos(this.value);
        });
    }
    
    // Custos
    if (custoMedioInput) {
        custoMedioInput.addEventListener('input', calcularCustoTotal);
        custoMedioInput.addEventListener('blur', calcularCustoTotal);
    }
    
    if (custoIndustrializacaoInput) {
        custoIndustrializacaoInput.addEventListener('input', calcularCustoTotal);
        custoIndustrializacaoInput.addEventListener('blur', calcularCustoTotal);
    }
    
    // =========================================================================
    // VALIDA√á√ÉO DE FORMUL√ÅRIO
    // =========================================================================
    
    const form = document.getElementById('produto-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìù Validando formul√°rio...');
            
            let hasErrors = false;
            const errorFields = [];
            
            // Remover classes de erro anteriores
            const allFields = form.querySelectorAll('.form-control, .form-select');
            allFields.forEach(field => field.classList.remove('is-invalid'));
            
            // Validar campos obrigat√≥rios b√°sicos
            const requiredFields = [
                { field: document.getElementById('{{ form.nome.id_for_label }}'), name: 'Nome' },
                { field: grupoSelect, name: 'Grupo' },
                { field: subgrupoSelect, name: 'Subgrupo' },
                { field: document.getElementById('{{ form.unidade_medida.id_for_label }}'), name: 'Unidade' },
                { field: tipoPiSelect, name: 'Tipo do PI' } // SEMPRE OBRIGAT√ìRIO
            ];
            
            requiredFields.forEach(({field, name}) => {
                if (field && (!field.value || !field.value.trim())) {
                    field.classList.add('is-invalid');
                    errorFields.push(name);
                    hasErrors = true;
                    console.log('‚ùå Campo obrigat√≥rio vazio:', name);
                }
            });
            
            // Valida√ß√µes condicionais baseadas no tipo_pi
            if (tipoPiSelect && tipoPiSelect.value && tiposInfo[tipoPiSelect.value]) {
                const tipoInfo = tiposInfo[tipoPiSelect.value];
                
                // Validar fornecedor se obrigat√≥rio
                if (tipoInfo.fornecedor_obrigatorio && fornecedorSelect && !fornecedorSelect.value) {
                    fornecedorSelect.classList.add('is-invalid');
                    errorFields.push('Fornecedor Principal');
                    hasErrors = true;
                    console.log('‚ùå Fornecedor obrigat√≥rio para tipo:', tipoPiSelect.value);
                }
                
                // Validar custo m√©dio se obrigat√≥rio
                if (tipoInfo.custo_manual && custoMedioInput && !custoMedioInput.value) {
                    custoMedioInput.classList.add('is-invalid');
                    errorFields.push('Custo M√©dio');
                    hasErrors = true;
                    console.log('‚ùå Custo m√©dio obrigat√≥rio para tipo:', tipoPiSelect.value);
                }
            }
            
            if (hasErrors) {
                e.preventDefault();
                
                console.log('‚ùå Formul√°rio com erros:', errorFields);
                
                // Mostrar alerta com erros
                alert(`Por favor, corrija os seguintes campos obrigat√≥rios:\n\n‚Ä¢ ${errorFields.join('\n‚Ä¢ ')}\n\nVerifique se todos os campos marcados com * est√£o preenchidos.`);
                
                // Scroll para o primeiro erro
                const firstError = form.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                
                updateDebugInfo();
            } else {
                // Mostrar loading no bot√£o
                const submitBtn = document.getElementById('submit-btn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
                    submitBtn.disabled = true;
                }
                
                console.log('‚úÖ Formul√°rio v√°lido, enviando...');
            }
        });
    }
    
    // =========================================================================
    // INICIALIZA√á√ÉO
    // =========================================================================
    
    console.log('üöÄ Executando inicializa√ß√£o...');
    
    // Sempre mostrar se√ß√£o tipo_pi (removendo l√≥gica de esconder)
    const tipoPiSection = document.getElementById('tipo-pi-section');
    if (tipoPiSection) {
        tipoPiSection.style.display = 'block';
        console.log('‚úÖ Se√ß√£o tipo_pi sempre vis√≠vel');
    }
    
    // Marcar tipo_pi como obrigat√≥rio sempre
    if (tipoPiSelect) {
        tipoPiSelect.required = true;
        console.log('‚úÖ Campo tipo_pi marcado como obrigat√≥rio');
    }
    
    // Executar fun√ß√µes iniciais
    calcularCustoTotal();
    updateTipoPiInfo();
    updateDebugInfo();
    
    // Se for edi√ß√£o, configurar campos baseados nos valores existentes
    {% if form.instance.pk %}
        console.log('üìù Modo edi√ß√£o detectado');
        
        // Carregar subgrupos se tem grupo
        if (grupoSelect && grupoSelect.value) {
            console.log('üîÑ Carregando subgrupos para grupo da edi√ß√£o');
            updateSubgrupos(grupoSelect.value);
        }
        
        // Configurar tipo_pi se j√° existe
        if (tipoPiSelect && tipoPiSelect.value) {
            console.log('üîÑ Configurando tipo PI da edi√ß√£o:', tipoPiSelect.value);
            updateTipoPiInfo();
        }
        
        // Calcular custo atual
        setTimeout(calcularCustoTotal, 100);
        
    {% else %}
        console.log('‚ú® Modo cria√ß√£o detectado');
        
        // Para cria√ß√£o, manter tipo_pi vis√≠vel e obrigat√≥rio
        console.log('‚úÖ Tipo PI obrigat√≥rio para novo produto');
    {% endif %}
    
    // =========================================================================
    // LOG FINAL
    // =========================================================================
    
    setTimeout(() => {
        console.log('üîß Status final do formul√°rio:', {
            modo: '{% if form.instance.pk %}edicao{% else %}criacao{% endif %}',
            tipo_pi_visivel: tipoPiSection ? tipoPiSection.style.display !== 'none' : 'N/A',
            tipo_pi_required: tipoPiSelect ? tipoPiSelect.required : 'N/A',
            tipo_pi_value: tipoPiSelect ? tipoPiSelect.value : 'N/A',
            grupo_value: grupoSelect ? grupoSelect.value : 'N/A',
            subgrupo_value: subgrupoSelect ? subgrupoSelect.value : 'N/A'
        });
        
        updateDebugInfo();
    }, 500);
});
</script>
{% endblock %}