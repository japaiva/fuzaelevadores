<!-- regra_yaml_form.html CORRIGIDO -->
{% extends 'producao/base_producao.html' %}

{% block title %}{{ titulo }} | Portal Produção{% endblock %}

{% block content %}
<div class="container-fluid"> <!-- CONTAINER MAIS LARGO -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-plus{% endif %} me-2"></i>
        {{ titulo }}
      </h5>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#regrasYamlHelpModal">
          <i class="fas fa-question-circle me-1"></i> Ajuda
        </button>
        <a href="{% url 'producao:regras_yaml_list' %}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>

    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            <h6><i class="fas fa-exclamation-triangle me-1"></i> Erros no Formulário:</h6>
            {% for error in form.non_field_errors %}
              <p class="mb-1">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <div class="row g-3">
          <div class="col-md-3"> <!-- REDUZIDO PARA DAR MAIS ESPAÇO -->
            <label for="{{ form.tipo.id_for_label }}" class="form-label">
              {{ form.tipo.label }} <span class="text-danger">*</span>
            </label>
            {{ form.tipo }}
            {% if form.tipo.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.tipo.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="col-md-7"> <!-- AUMENTADO -->
            <label for="{{ form.nome.id_for_label }}" class="form-label">
              {{ form.nome.label }} <span class="text-danger">*</span>
            </label>
            {{ form.nome }}
            {% if form.nome.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.nome.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="col-md-2">
            <div class="form-check form-switch mt-4">
              {{ form.ativa }}
              <label class="form-check-label fw-semibold" for="{{ form.ativa.id_for_label }}">
                {{ form.ativa.label }}
              </label>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-12">
            <label for="{{ form.conteudo_yaml.id_for_label }}" class="form-label">
              {{ form.conteudo_yaml.label }} <span class="text-danger">*</span>
              <button type="button" class="btn btn-outline-info btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#regrasYamlHelpModal">
                <i class="fas fa-question-circle me-1"></i> Ver Ajuda
              </button>
            </label>
            {{ form.conteudo_yaml }}
            {% if form.conteudo_yaml.errors %}
              <div class="text-danger small mt-1">
                {% for error in form.conteudo_yaml.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        {% if form.instance.pk %}
        <div class="row g-3 mt-3">
          <div class="col-12">
            <div class="alert alert-info">
              <h6><i class="fas fa-info-circle me-1"></i> Informações da Regra</h6>
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong>Versão:</strong> {{ form.instance.versao }}</p>
                  <p class="mb-1"><strong>Criado em:</strong> {{ form.instance.criado_em|date:"d/m/Y H:i" }}</p>
                  <p class="mb-0"><strong>Criado por:</strong> {{ form.instance.criado_por.first_name|default:form.instance.criado_por.username }}</p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><strong>Última atualização:</strong> {{ form.instance.atualizado_em|date:"d/m/Y H:i" }}</p>
                  <p class="mb-1"><strong>Atualizado por:</strong> {{ form.instance.atualizado_por.first_name|default:form.instance.atualizado_por.username }}</p>
                  <p class="mb-0">
                    <strong>Status:</strong>
                    {% if form.instance.validado %}
                      <span class="badge bg-success">Validado</span>
                    {% else %}
                      <span class="badge bg-warning">Precisa validar</span>
                    {% endif %}
                  </p>
                </div>
              </div>
              {% if not form.instance.validado and form.instance.ultimo_erro %}
                <hr class="my-2">
                <div class="text-muted small">
                  <strong>Último erro:</strong><br>
                  <code>{{ form.instance.ultimo_erro }}</code>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light rounded">
          <div>
            {% if form.instance.pk %}
              <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                Última atualização: {{ form.instance.atualizado_em|date:"d/m/Y H:i" }}
              </small>
            {% endif %}
          </div>
          <div class="d-flex gap-2">
            <a href="{% url 'producao:regras_yaml_list' %}" class="btn btn-outline-secondary">
              <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i> 
              {% if form.instance.pk %}Atualizar{% else %}Salvar{% endif %} Regra
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- INCLUIR O MODAL DE HELP -->
{% include 'producao/partials/regras_yaml_help.html' %}
{% endblock %}

{% block extra_css %}
<style>
.font-monospace {
  font-family: 'Courier New', Consolas, Monaco, monospace;
  font-size: 15px;
  line-height: 1.5;
}

/* Textarea YAML MUITO maior */
#{{ form.conteudo_yaml.id_for_label }} {
  min-height: 600px;
  max-height: 800px;
  resize: vertical;
  font-size: 14px;
}

/* Container MÁXIMO possível */
.container-fluid {
  max-width: none;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
  margin-left: 0;
  margin-right: 0;
}

@media (min-width: 768px) {
  .container-fluid {
    padding-left: 1rem;
    padding-right: 1rem;
  }
}

@media (min-width: 1200px) {
  .container-fluid {
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }
}

@media (min-width: 1400px) {
  .container-fluid {
    padding-left: 2rem;
    padding-right: 2rem;
  }
}

/* Card com largura máxima */
.card {
  width: 100%;
  max-width: none;
}

/* Inputs maiores e mais legíveis */
.form-control, .form-select {
  font-size: 15px;
  padding: 0.6rem 0.75rem;
}

/* Labels maiores */
.form-label {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 0.7rem;
}

/* Espaçamento entre seções */
.row.g-3 {
  margin-bottom: 1.5rem;
}

/* Alert de informações mais espaçoso */
.alert {
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

/* Footer com mais espaço */
.d-flex.justify-content-between.align-items-center.mt-4 {
  padding: 1.5rem;
  margin-top: 2rem !important;
}

/* Botões maiores */
.btn {
  padding: 0.7rem 1.2rem;
  font-size: 15px;
}

.btn-sm {
  padding: 0.5rem 0.8rem;
  font-size: 14px;
}
</style>
{% endblock %}