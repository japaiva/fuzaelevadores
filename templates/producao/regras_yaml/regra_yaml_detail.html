{% extends 'producao/base_producao.html' %}

{% block title %}{{ regra.nome }} | Portal Produção{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-eye me-2"></i>
      Detalhes da Regra: {{ regra.nome }}
    </h5>
    <div>
      <a href="{% url 'producao:regra_yaml_update' regra.pk %}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-edit me-1"></i> Editar
      </a>
      <a href="{% url 'producao:regras_yaml_list' %}" class="btn btn-outline-light btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
  </div>

  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6>Informações Básicas</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Tipo:</strong></td>
            <td><span class="badge bg-primary">{{ regra.get_tipo_display }}</span></td>
          </tr>
          <tr>
            <td><strong>Nome:</strong></td>
            <td>{{ regra.nome }}</td>
          </tr>
          <tr>
            <td><strong>Versão:</strong></td>
            <td><span class="badge bg-secondary">v{{ regra.versao }}</span></td>
          </tr>
          <tr>
            <td><strong>Status:</strong></td>
            <td>
              {% if regra.ativa %}
                <span class="badge bg-success">Ativa</span>
              {% else %}
                <span class="badge bg-secondary">Inativa</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td><strong>Validação:</strong></td>
            <td>
              {% if regra.validado %}
                <span class="badge bg-success">
                  <i class="fas fa-check me-1"></i>Validado
                </span>
              {% else %}
                <span class="badge bg-warning">
                  <i class="fas fa-exclamation-triangle me-1"></i>Com Erros
                </span>
              {% endif %}
            </td>
          </tr>
        </table>
      </div>
      
      <div class="col-md-6">
        <h6>Auditoria</h6>
        <table class="table table-sm">
          <tr>
            <td><strong>Criado em:</strong></td>
            <td>{{ regra.criado_em|date:"d/m/Y H:i" }}</td>
          </tr>
          <tr>
            <td><strong>Criado por:</strong></td>
            <td>{{ regra.criado_por.first_name|default:regra.criado_por.username }}</td>
          </tr>
          <tr>
            <td><strong>Atualizado em:</strong></td>
            <td>{{ regra.atualizado_em|date:"d/m/Y H:i" }}</td>
          </tr>
          <tr>
            <td><strong>Atualizado por:</strong></td>
            <td>{{ regra.atualizado_por.first_name|default:regra.atualizado_por.username }}</td>
          </tr>
        </table>
      </div>
    </div>

    {% if regra.descricao %}
    <div class="row mt-3">
      <div class="col-12">
        <h6>Descrição</h6>
        <p class="text-muted">{{ regra.descricao }}</p>
      </div>
    </div>
    {% endif %}

    {% if not regra.validado and regra.ultimo_erro %}
    <div class="row mt-3">
      <div class="col-12">
        <div class="alert alert-warning">
          <h6><i class="fas fa-exclamation-triangle me-1"></i> Erros de Validação</h6>
          <pre class="mb-0">{{ regra.ultimo_erro }}</pre>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row mt-3">
      <div class="col-12">
        <h6>Conteúdo YAML</h6>
        <div class="bg-light p-3 rounded">
          <pre class="mb-0"><code>{{ regra.conteudo_yaml }}</code></pre>
        </div>
      </div>
    </div>

    {% if dados_yaml %}
    <div class="row mt-3">
      <div class="col-12">
        <h6>Estrutura Interpretada</h6>
        <div class="bg-light p-3 rounded">
          <pre class="mb-0"><code>{{ dados_yaml|pprint }}</code></pre>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="card-footer">
    <div class="d-flex gap-2">
      <a href="{% url 'producao:regra_yaml_validar' regra.pk %}" class="btn btn-warning btn-sm">
        <i class="fas fa-check-circle me-1"></i> Validar Regra
      </a>
      <a href="{% url 'producao:regra_yaml_toggle_status' regra.pk %}" 
         class="btn btn-sm {% if regra.ativa %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
        <i class="fas {% if regra.ativa %}fa-toggle-off{% else %}fa-toggle-on{% endif %} me-1"></i>
        {% if regra.ativa %}Desativar{% else %}Ativar{% endif %}
      </a>
    </div>
  </div>
</div>
{% endblock %}