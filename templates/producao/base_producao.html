{% extends 'base.html' %}

{% block title %}Portal Producao{% endblock %}

{% block navbar_title %}
<span class="app-title-text">Portal Producao</span>
{% endblock %}

{% block nav_items %}

<!-- Adm -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'grupo' in request.resolver_match.url_name or 'subgrupo' in request.resolver_match.url_name or 'materiaprima' in request.resolver_match.url_name or 'produto_intermediario' in request.resolver_match.url_name or 'produto_acabado' in request.resolver_match.url_name or 'tipo_movimento' in request.resolver_match.url_name or 'fornecedor' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Adm
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:grupo_list' %}">
        Grupos de Produtos
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:subgrupo_list' %}">
        Subgrupos de Produtos
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:materiaprima_list' %}">
        Materias-Primas
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:produto_intermediario_list' %}">
        Produtos Intermediarios
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:produto_acabado_list' %}">
        Produtos Acabados
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:fornecedor_list' %}">
        Fornecedores
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:tipo_movimento_entrada_list' %}">
        Tipos Mov. Entrada
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:tipo_movimento_saida_list' %}">
        Tipos Mov. Saida
    </a></li>
  </ul>
</li>

<!-- Engenharia -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'proposta' in request.resolver_match.url_name or 'regras' in request.resolver_match.url_name or 'formulas' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Engenharia
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:proposta_list_producao' %}">
        Projetos
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:regras_yaml_list' %}">
        Regras Composicao Preco
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:formulas_calculo' %}">
        Formulas de Calculo
    </a></li>
  </ul>
</li>

<!-- Suprimentos -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'requisicao' in request.resolver_match.url_name or 'orcamento' in request.resolver_match.url_name or 'pedido' in request.resolver_match.url_name or 'saldo' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Suprimentos
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:requisicao_compra_list' %}">
        Requisicao de Compra
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:orcamento_compra_list' %}">
        Orcamento de Compra
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:pedido_compra_list' %}">
        Pedido de Compra
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:relatorio_saldos_requisicoes' %}">
        Saldo Requisicao
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:relatorio_produtos_completo' %}">
        Relatorio Produtos
    </a></li>
  </ul>
</li>

<!-- Materiais -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'entrada' in request.resolver_match.url_name or 'saida' in request.resolver_match.url_name or 'posicao' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Materiais
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:movimento_entrada_list' %}">
        Entradas
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:movimento_saida_list' %}">
        Saidas
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:posicao_estoque' %}">
        Posicao Estoque
    </a></li>
  </ul>
</li>

<!-- Producao -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'ordem_producao' in request.resolver_match.url_name or 'op_list' in request.resolver_match.url_name or 'requisicao_material' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Producao
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:op_list' %}">
        Ordens de Producao
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:requisicao_material_list' %}">
        Requisicao de Material
    </a></li>
  </ul>
</li>

{% endblock %}

{% block extra_css %}
<!-- Estilos removidos - agora usando estilos globais do style.css -->
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Fazer botoes "Voltar" retornarem para a pagina anterior de forma inteligente
document.addEventListener('DOMContentLoaded', function() {
    const paginaAnterior = document.referrer;
    const botoesVoltar = document.querySelectorAll('a i.fa-arrow-left');

    botoesVoltar.forEach(function(icone, index) {
        const botao = icone.closest('a');
        if (botao) {
            const hrefOriginal = botao.getAttribute('href');
            const ehDestinoCerto = hrefOriginal && (
                hrefOriginal.includes('_list') ||
                hrefOriginal.includes('/list/') ||
                hrefOriginal.includes('dashboard')
            );

            if (ehDestinoCerto) {
                return;
            }

            botao.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const mesmoSite = paginaAnterior && paginaAnterior.includes(window.location.hostname);
                const veioDeOutraPagina = paginaAnterior && paginaAnterior !== window.location.href;

                if (mesmoSite && veioDeOutraPagina) {
                    window.location.href = paginaAnterior;
                } else if (hrefOriginal) {
                    window.location.href = hrefOriginal;
                } else {
                    window.history.back();
                }
            });
        }
    });

    // Atualizar contador de tarefas pendentes
    function atualizarContadorTarefas() {
        fetch('{% url "producao:tarefas_contador" %}')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('badge-tarefas-pendentes');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => console.error('Erro ao buscar contador de tarefas:', error));
    }

    atualizarContadorTarefas();
    setInterval(atualizarContadorTarefas, 60000);
});
</script>
{% endblock %}
