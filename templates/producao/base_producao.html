{% extends 'base.html' %}

{% block title %}Portal Produ√ß√£o{% endblock %}

{% block navbar_title %}
<span class="app-title-text">Portal Produ√ß√£o</span>
{% endblock %}

{% block nav_items %}

<!-- Divisor vertical -->
<li class="nav-item">
  <span class="nav-link" style="border-left: 2px solid #60a5fa; height: 24px; margin: 8px 15px;"></span>
</li>

<!-- Menu de Cadastros B√°sicos -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'usuario' in request.resolver_match.url_name or 'grupo' in request.resolver_match.url_name or 'subgrupo' in request.resolver_match.url_name or 'fornecedor' in request.resolver_match.url_name or 'cliente' in request.resolver_match.url_name or 'parametros' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
     Cadastros
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:fornecedor_list' %}">
        Fornecedores
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:materiaprima_list' %}">
        Mat√©rias-Primas
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:produto_intermediario_list' %}">
        Produtos Intermedi√°rios
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:grupo_list' %}">
        Grupos de Produtos
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:subgrupo_list' %}">
        Subgrupos de Produtos
    </a></li>
  </ul>
</li>

<!-- Menu de Compras e Or√ßamentos -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'compra' in request.resolver_match.url_name or 'orcamento' in request.resolver_match.url_name or 'requisicao' in request.resolver_match.url_name or 'proposta' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Suprimentos
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:proposta_list_producao' %}">
        Propostas
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:requisicao_compra_list' %}">
        Requisi√ß√µes de Compra
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:orcamento_compra_list' %}">
        Or√ßamentos de Compra
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:pedido_compra_list' %}">
        Pedidos de Compra
    </a></li>
  </ul>
</li>

<!-- Adm -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'relatorio' in request.resolver_match.url_name or 'regras' in request.resolver_match.url_name or 'saldo' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Adm
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:relatorio_produtos_completo' %}">
        Relat√≥rio de Produtos
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:relatorio_saldos_requisicoes' %}">
        Saldos de Requisi√ß√µes
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:regras_yaml_list' %}">
        Regras Composi√ß√£o Pre√ßo
    </a></li>
  </ul>
</li>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Fazer todos os bot√µes "Voltar" retornarem para a p√°gina anterior de forma inteligente
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Inicializando bot√µes voltar inteligentes...');

    // Guardar a p√°gina de onde veio ao carregar
    const paginaAnterior = document.referrer;
    console.log('üìÑ P√°gina anterior (referrer):', paginaAnterior);

    // Selecionar TODOS os links/bot√µes que cont√™m o √≠cone fa-arrow-left
    const botoesVoltar = document.querySelectorAll('a i.fa-arrow-left');
    console.log('üìç Bot√µes voltar encontrados:', botoesVoltar.length);

    botoesVoltar.forEach(function(icone, index) {
        const botao = icone.closest('a');
        if (botao) {
            const hrefOriginal = botao.getAttribute('href');
            console.log(`‚úÖ Bot√£o ${index + 1} - href original:`, hrefOriginal);

            // Adicionar evento de clique
            botao.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                console.log('‚¨ÖÔ∏è Processando voltar...');

                // ESTRAT√âGIA INTELIGENTE:
                // 1. Se h√° referrer e veio de dentro do site, usar referrer
                // 2. Caso contr√°rio, usar history.back()

                const mesmoSite = paginaAnterior && paginaAnterior.includes(window.location.hostname);
                const veioDeOutraPagina = paginaAnterior && paginaAnterior !== window.location.href;

                if (mesmoSite && veioDeOutraPagina) {
                    console.log('‚úÖ Voltando via referrer:', paginaAnterior);
                    window.location.href = paginaAnterior;
                } else {
                    console.log('‚úÖ Voltando via history.back()');
                    window.history.back();
                }
            });
        }
    });
});
</script>
{% endblock %}