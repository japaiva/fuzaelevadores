{% extends 'base.html' %}

{% block title %}Portal Produ√ß√£o{% endblock %}

{% block navbar_title %}
<span class="app-title-text">Portal Produ√ß√£o</span>
{% endblock %}

{% block nav_items %}

<!-- üîß Engenharia -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'proposta' in request.resolver_match.url_name or 'regras' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Engenharia
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:proposta_list_producao' %}">
        Gest√£o Projetos
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:regras_yaml_list' %}">
        Regras Composi√ß√£o Pre√ßo
    </a></li>
  </ul>
</li>

<!-- üõí Suprimentos -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'requisicao' in request.resolver_match.url_name or 'orcamento' in request.resolver_match.url_name or 'pedido' in request.resolver_match.url_name or 'saldo' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Suprimentos
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <li><a class="dropdown-item" href="{% url 'producao:requisicao_compra_list' %}">
        Requisi√ß√£o de Compra
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:orcamento_compra_list' %}">
        Or√ßamento de Compra
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:pedido_compra_list' %}">
        Pedido de Compra
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:relatorio_saldos_requisicoes' %}">
        Saldo Requisi√ß√£o
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:materiaprima_list' %}">
        Mat√©ria Prima
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:produto_intermediario_list' %}">
        Produto Intermedi√°rio
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:grupo_list' %}">
        Grupo Produtos
    </a></li>
    <li><a class="dropdown-item" href="{% url 'producao:subgrupo_list' %}">
        Subgrupo Produtos
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:fornecedor_list' %}">
        Fornecedores
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{% url 'producao:relatorio_produtos_completo' %}">
        Relat√≥rio Produtos
    </a></li>





  </ul>
</li>

<!-- üõí Almoxarifado -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'recebimento' in request.resolver_match.url_name or 'estoque' in request.resolver_match.url_name or 'inventario' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Almoxarifado
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <!-- FUTURO -->
    <li><a class="dropdown-item disabled" href="#">
        Recebimento Material
    </a></li>
    <li><a class="dropdown-item disabled" href="#">
        Saldo Estoque MP/PI
    </a></li>
    <li><a class="dropdown-item disabled" href="#">
        Invent√°rio
    </a></li>
  </ul>
</li>

<!-- üè≠ Produ√ß√£o -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'ordem' in request.resolver_match.url_name or 'remessa' in request.resolver_match.url_name or 'retorno' in request.resolver_match.url_name or 'apontamento' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Produ√ß√£o
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <!-- FUTURO -->
    <li><a class="dropdown-item disabled" href="#">
        Ordens de Produ√ß√£o
    </a></li>
    <li><a class="dropdown-item disabled" href="#">
        Apontamentos
    </a></li>
  </ul>
</li>

<!-- üöö Log√≠stica -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle {% if 'expedicao' in request.resolver_match.url_name or 'entrega' in request.resolver_match.url_name or 'transportadora' in request.resolver_match.url_name %}active{% endif %}" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Log√≠stica
  </a>
  <ul class="dropdown-menu dropdown-menu-dark">
    <!-- FUTURO -->
    <li><a class="dropdown-item disabled" href="#">
        Expedi√ß√£o
    </a></li>
    <li><a class="dropdown-item disabled" href="#">
        Entregas Programadas
    </a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item disabled" href="#">
        Transportadoras
    </a></li>
  </ul>
</li>




{% endblock %}

{% block extra_css %}
<!-- Estilos removidos - agora usando estilos globais do style.css -->
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Fazer bot√µes "Voltar" retornarem para a p√°gina anterior de forma inteligente
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Inicializando bot√µes voltar inteligentes...');

    // Guardar a p√°gina de onde veio ao carregar
    const paginaAnterior = document.referrer;
    console.log('üìÑ P√°gina anterior (referrer):', paginaAnterior);

    // Selecionar TODOS os links/bot√µes que cont√™m o √≠cone fa-arrow-left
    const botoesVoltar = document.querySelectorAll('a i.fa-arrow-left');
    console.log('üìç Bot√µes voltar encontrados:', botoesVoltar.length);

    botoesVoltar.forEach(function(icone, index) {
        const botao = icone.closest('a');
        if (botao) {
            const hrefOriginal = botao.getAttribute('href');
            console.log(`‚úÖ Bot√£o ${index + 1} - href original:`, hrefOriginal);

            // REGRA: Se o href aponta para uma lista ou dashboard, SEMPRE usar o href
            // S√≥ usar history.back() para navega√ß√£o entre detalhes/edi√ß√£o
            const ehDestinoCerto = hrefOriginal && (
                hrefOriginal.includes('_list') ||
                hrefOriginal.includes('/list/') ||
                hrefOriginal.includes('dashboard')
            );

            if (ehDestinoCerto) {
                console.log(`üìå Bot√£o ${index + 1} aponta para destino espec√≠fico, mantendo href`);
                // N√£o adicionar listener - deixar comportamento padr√£o
                return;
            }

            // Para outros casos, tentar voltar inteligentemente
            botao.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                console.log('‚¨ÖÔ∏è Processando voltar...');

                const mesmoSite = paginaAnterior && paginaAnterior.includes(window.location.hostname);
                const veioDeOutraPagina = paginaAnterior && paginaAnterior !== window.location.href;

                if (mesmoSite && veioDeOutraPagina) {
                    console.log('‚úÖ Voltando via referrer:', paginaAnterior);
                    window.location.href = paginaAnterior;
                } else if (hrefOriginal) {
                    console.log('‚úÖ Usando href como fallback:', hrefOriginal);
                    window.location.href = hrefOriginal;
                } else {
                    console.log('‚úÖ Voltando via history.back()');
                    window.history.back();
                }
            });
        }
    });

    // Atualizar contador de tarefas pendentes
    function atualizarContadorTarefas() {
        fetch('{% url "producao:tarefas_contador" %}')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('badge-tarefas-pendentes');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => console.error('Erro ao buscar contador de tarefas:', error));
    }

    // Atualizar ao carregar a p√°gina
    atualizarContadorTarefas();

    // Atualizar a cada 60 segundos
    setInterval(atualizarContadorTarefas, 60000);
});
</script>
{% endblock %}
