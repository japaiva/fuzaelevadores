{% extends 'vendedor/base_vendedor.html' %}

{% block title %}
  {% if editing %}
    Editar Proposta {{ pedido.numero }} - Cabine/Portas | Portal do Vendedor
  {% else %}
    Proposta {{ pedido.numero }} - Cabine/Portas | Portal do Vendedor
  {% endif %}
{% endblock %}

{% block content %}
<div class="container">
  <div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        {% if editing %}
          <i class="fas fa-edit me-2"></i>Editar Proposta {{ pedido.numero }} - Cabine/Portas
        {% else %}
          <i class="fas fa-square me-2"></i>Proposta {{ pedido.numero }} - Cabine/Portas
        {% endif %}
      </h5>

      <a href="{% if editing %}{% url 'vendedor:pedido_detail' pedido.pk %}{% else %}{% url 'vendedor:proposta_list' %}{% endif %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> {% if editing %}Cancelar{% else %}Voltar{% endif %}
     </a>
    </div>

    <div class="card-header bg-white">
      <div class="progress" style="height: 6px;">
        <div class="progress-bar {% if editing %}bg-warning{% else %}bg-success{% endif %}" role="progressbar" style="width: 66%" aria-valuenow="66" aria-valuemax="100"></div>
      </div>
      <div class="d-flex justify-content-between mt-2">
        <small class="{% if editing %}text-warning{% else %}text-success{% endif %} fw-bold">1. Projeto/Elevador</small>
        <small class="text-muted">2. Cabine/Portas</small>
        <small class="text-muted">3. Comercial</small>
      </div>
    </div>
    
    <div class="card-body">
      <form id="cabinePortasForm" method="post">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
              <p class="mb-0">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
        
        <!-- Bloco 1: Cabine ATUALIZADO -->
        <div class="card shadow-sm border-primary mb-4">
          <div class="card-header bg-primary text-white">
            <h6 class="card-title mb-0">Cabine</h6>
          </div>
          <div class="card-body">



            <!-- Material, Acabamento, Saída e Abertura da Cabine -->
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label" for="{{ form.material_cabine.id_for_label }}">Material da Cabine*</label>
                {{ form.material_cabine }}
                {% if form.material_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.material_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label" for="{{ form.espessura_cabine.id_for_label }}">Espessura*</label>
                {{ form.espessura_cabine }}
                {% if form.espessura_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.espessura_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label" for="{{ form.saida_cabine.id_for_label }}">Saída*</label>
                {{ form.saida_cabine }}
                {% if form.saida_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.saida_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Segunda linha: Altura da Cabine -->
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label class="form-label" for="{{ form.altura_cabine.id_for_label }}">Altura da Cabine (m)*</label>
                {{ form.altura_cabine }}
                {% if form.altura_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.altura_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label class="form-label" for="{{ form.piso_cabine.id_for_label }}">Responsável pelo Piso*</label>
                {{ form.piso_cabine }}
                {% if form.piso_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.piso_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4" id="material-piso-div" style="display: none;">
                <label class="form-label" for="{{ form.material_piso_cabine.id_for_label }}">Material do Piso</label>
                {{ form.material_piso_cabine }}
                {% if form.material_piso_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.material_piso_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Porta da Cabine -->
        <div class="card shadow-sm border-success mb-4">
          <div class="card-header bg-success text-white">
            <h6 class="card-title mb-0">Porta da Cabine</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label" for="{{ form.modelo_porta_cabine.id_for_label }}">Modelo*</label>
                {{ form.modelo_porta_cabine }}
                {% if form.modelo_porta_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.modelo_porta_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label" for="{{ form.material_porta_cabine.id_for_label }}">Material*</label>
                {{ form.material_porta_cabine }}
                {% if form.material_porta_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.material_porta_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4" id="folhas-cabine-div" style="display: none;">
                <label class="form-label" for="{{ form.folhas_porta_cabine.id_for_label }}">Folhas</label>
                {{ form.folhas_porta_cabine }}
                {% if form.folhas_porta_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.folhas_porta_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>

              <!-- NOVO CAMPO: Abertura da Cabine -->
              <div class="col-md-4">
                <label class="form-label" for="{{ form.abertura_cabine.id_for_label }}">Abertura*</label>
                {{ form.abertura_cabine }}
                {% if form.abertura_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.abertura_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Dimensões -->
              <div class="col-md-4">
                <label class="form-label" for="{{ form.largura_porta_cabine.id_for_label }}">Largura (m)*</label>
                {{ form.largura_porta_cabine }}
                {% if form.largura_porta_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.largura_porta_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label" for="{{ form.altura_porta_cabine.id_for_label }}">Altura (m)*</label>
                {{ form.altura_porta_cabine }}
                {% if form.altura_porta_cabine.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.altura_porta_cabine.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Portas Individuais por Pavimento -->
        <div class="card shadow-sm border-info mb-4">
          <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">
              <i class="fas fa-building me-2"></i>Configuração Individual por Pavimento
              <small class="text-light ms-2">({{ total_pavimentos }} pavimentos)</small>
            </h6>
            <button type="button" class="btn btn-light btn-sm" id="replicar-terreo-btn">
              <i class="fas fa-copy me-1"></i>Replicar do Térreo
            </button>
          </div>
          <div class="card-body">
            <div class="row" id="portas_container">
              {% for porta in portas_pavimento %}
              <div class="col-md-6 mb-4" data-andar="{{ porta.andar }}">
                <div class="card border-secondary h-100">
                  <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <strong>{{ porta.nome_andar }}</strong>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" 
                             name="porta_ativo_{{ porta.andar }}" 
                             id="ativo_{{ porta.andar }}"
                             {% if porta.ativo %}checked{% endif %}>
                      <label class="form-check-label small" for="ativo_{{ porta.andar }}">
                        Ativo
                      </label>
                    </div>
                  </div>
                  <div class="card-body p-3">
                    <!-- Nome do Andar -->
                    <div class="row g-2 mb-3">
                      <div class="col-12">
                        <label class="form-label small">Nome do Andar</label>
                        <input type="text" class="form-control form-control-sm" 
                               name="porta_nome_{{ porta.andar }}" 
                               value="{{ porta.nome_andar }}"
                               placeholder="Ex: Térreo, 1º Andar, Cobertura">
                      </div>
                    </div>
                    
                    <!-- Configurações Específicas -->
                    <div class="row g-2 mb-3">
                      <div class="col-6">
                        <label class="form-label small">Saída</label>
                        <select name="porta_saida_{{ porta.andar }}" class="form-select form-select-sm">
                          <option value="normal" {% if porta.saida == 'normal' %}selected{% endif %}>Normal</option>
                          <option value="oposta" {% if porta.saida == 'oposta' %}selected{% endif %}>Oposta</option>
                        </select>
                      </div>
                      <div class="col-6">
                        <label class="form-label small">Abertura</label>
                        <select name="porta_abertura_{{ porta.andar }}" class="form-select form-select-sm">
                          <option value="direita" {% if porta.abertura_porta == 'direita' %}selected{% endif %}>Direita</option>
                          <option value="esquerda" {% if porta.abertura_porta == 'esquerda' %}selected{% endif %}>Esquerda</option>
                        </select>
                      </div>
                    </div>
                    
                    <!-- Modelo e Material -->
                    <div class="row g-2 mb-3">
                      <div class="col-6">
                        <label class="form-label small">Modelo</label>
                        <select name="porta_modelo_{{ porta.andar }}" class="form-select form-select-sm modelo-porta-select">
                          <option value="Automática" {% if porta.modelo == 'Automática' %}selected{% endif %}>Automática</option>
                          <option value="Pantográfica" {% if porta.modelo == 'Pantográfica' %}selected{% endif %}>Pantográfica</option>
                          <option value="Pivotante" {% if porta.modelo == 'Pivotante' %}selected{% endif %}>Pivotante</option>
                          <option value="Guilhotina" {% if porta.modelo == 'Guilhotina' %}selected{% endif %}>Guilhotina</option>
                          <option value="Camarão" {% if porta.modelo == 'Camarão' %}selected{% endif %}>Camarão</option>
                          <option value="Cancela" {% if porta.modelo == 'Cancela' %}selected{% endif %}>Cancela</option>
                          <option value="Rampa" {% if porta.modelo == 'Rampa' %}selected{% endif %}>Rampa</option>
                        </select>
                      </div>
                      <div class="col-6">
                        <label class="form-label small">Material</label>
                        <select name="porta_material_{{ porta.andar }}" class="form-select form-select-sm">
                          <option value="Inox 430" {% if porta.material == 'Inox 430' %}selected{% endif %}>Inox 430</option>
                          <option value="Inox 304" {% if porta.material == 'Inox 304' %}selected{% endif %}>Inox 304</option>
                          <option value="Chapa Pintada" {% if porta.material == 'Chapa Pintada' %}selected{% endif %}>Chapa Pintada</option>
                          <option value="Alumínio" {% if porta.material == 'Alumínio' %}selected{% endif %}>Alumínio</option>
                        </select>
                      </div>
                    </div>
                    
                    <!-- Dimensões -->
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <label class="form-label small">Largura (m)</label>
                            <input type="text" 
                                  class="form-control form-control-sm" 
                                  name="porta_largura_{{ porta.andar }}" 
                                  value="{% if porta.largura %}{{ porta.largura }}{% endif %}"
                                  placeholder="0,00">
                        </div>
                        
                        <div class="col-4">
                            <label class="form-label small">Altura (m)</label>
                            <input type="text" 
                                  class="form-control form-control-sm" 
                                  name="porta_altura_{{ porta.andar }}" 
                                  value="{% if porta.altura %}{{ porta.altura }}{% endif %}"
                                  placeholder="0,00">
                        </div>
                        
                        <div class="col-4 folhas-container" {% if porta.modelo != 'Automática' %}style="display: none;"{% endif %}>
                            <label class="form-label small">Folhas</label>
                            <select name="porta_folhas_{{ porta.andar }}" class="form-select form-select-sm">
                                <option value="2" {% if porta.folhas == '2' %}selected{% endif %}>2 Folhas</option>
                                <option value="3" {% if porta.folhas == '3' %}selected{% endif %}>3 Folhas</option>
                                <option value="4" {% if porta.folhas == '4' %}selected{% endif %}>4 Folhas</option>
                                <option value="Central" {% if porta.folhas == 'Central' %}selected{% endif %}>Central</option>
                            </select>
                        </div>
                    </div>

                    
                    <!-- Observações -->
                    <div class="row g-2">
                      <div class="col-12">
                        <label class="form-label small">Observações</label>
                        <textarea name="porta_observacoes_{{ porta.andar }}" 
                                  class="form-control form-control-sm" 
                                  rows="2" 
                                  placeholder="Características especiais deste pavimento...">{{ porta.observacoes }}</textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Botões de ação -->
        <div class="d-flex justify-content-between mt-4 mb-4">
          <a class="btn btn-outline-secondary" href="{% url 'vendedor:proposta_step1_edit' pedido.pk %}">
            <i class="fas fa-arrow-left me-1"></i> Anterior
          </a>

          <button type="submit" class="btn {% if editing %}btn-warning{% else %}btn-success{% endif %}">
              Próximo <i class="fas fa-arrow-right me-1"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 STEP 2: JavaScript inicializado');
    
    const form = document.getElementById('cabinePortasForm');
    
    // === ELEMENTOS DO FORMULÁRIO ===
    
    // Piso
    const pisoCabineSelect = document.getElementById('{{ form.piso_cabine.id_for_label }}');
    const materialPisoDiv = document.getElementById('material-piso-div');
    
    // Porta da Cabine
    const modeloPortaCabineSelect = document.getElementById('{{ form.modelo_porta_cabine.id_for_label }}');
    const folhasCabineDiv = document.getElementById('folhas-cabine-div');
    
    // Botão replicar do térreo
    const replicarTerreoBtn = document.getElementById('replicar-terreo-btn');
    
    // === FORMATAÇÃO DECIMAL COM VÍRGULA ===
    
    // Formatar campos decimais na inicialização
    function formatarCamposDecimais() {
        const camposDecimais = [
            '{{ form.altura_cabine.id_for_label }}',
            '{{ form.largura_porta_cabine.id_for_label }}',
            '{{ form.altura_porta_cabine.id_for_label }}'
        ];
        
        camposDecimais.forEach(id => {
            const campo = document.getElementById(id);
            if (campo && campo.value && campo.value.includes('.')) {
                campo.value = campo.value.replace('.', ',');
            }
        });
        
        // Também formatar campos das portas individuais
        document.querySelectorAll('input[name^="porta_largura_"], input[name^="porta_altura_"]').forEach(campo => {
            if (campo.value && campo.value.includes('.')) {
                campo.value = campo.value.replace('.', ',');
            }
        });
    }
    
    // === FUNÇÕES ===
    
    function togglePisoCabine() {
        if (!pisoCabineSelect || !materialPisoDiv) return;
        
        const isPorContaEmpresa = pisoCabineSelect.value === 'Por conta da empresa';
        materialPisoDiv.style.display = isPorContaEmpresa ? 'block' : 'none';
    }
    
    function togglePortaCabine() {
        if (modeloPortaCabineSelect && folhasCabineDiv) {
            const isAutomatica = modeloPortaCabineSelect.value === 'Automática';
            folhasCabineDiv.style.display = isAutomatica ? 'block' : 'none';
        }
    }
    
    function toggleFolhasPortasIndividuais() {
        const modeloSelects = document.querySelectorAll('.modelo-porta-select');
        
        modeloSelects.forEach(function(select) {
            const andar = select.name.split('_').pop();
            const folhasContainer = select.closest('.card-body').querySelector('.folhas-container');
            
            if (folhasContainer) {
                const isAutomatica = select.value === 'Automática';
                folhasContainer.style.display = isAutomatica ? 'block' : 'none';
            }
        });
    }
    
    function replicarConfiguracao() {
        const terreoCard = document.querySelector('[data-andar="0"]');
        if (!terreoCard) {
            alert('Não foi possível encontrar a configuração do térreo.');
            return;
        }
        
        const modeloTerreo = terreoCard.querySelector('select[name="porta_modelo_0"]')?.value;
        const materialTerreo = terreoCard.querySelector('select[name="porta_material_0"]')?.value;
        const saidaTerreo = terreoCard.querySelector('select[name="porta_saida_0"]')?.value;
        const aberturaTerreo = terreoCard.querySelector('select[name="porta_abertura_0"]')?.value;
        const larguraTerreo = terreoCard.querySelector('input[name="porta_largura_0"]')?.value;
        const alturaTerreo = terreoCard.querySelector('input[name="porta_altura_0"]')?.value;
        const folhasTerreo = terreoCard.querySelector('select[name="porta_folhas_0"]')?.value;
        
        const portasCards = document.querySelectorAll('[data-andar]');
        let pavimentosAtualizados = 0;
        
        portasCards.forEach(function(card) {
            const andar = card.getAttribute('data-andar');
            
            if (andar === '0') return;
            
            const selectModelo = card.querySelector(`select[name="porta_modelo_${andar}"]`);
            if (selectModelo && modeloTerreo) {
                selectModelo.value = modeloTerreo;
            }
            
            const selectMaterial = card.querySelector(`select[name="porta_material_${andar}"]`);
            if (selectMaterial && materialTerreo) {
                selectMaterial.value = materialTerreo;
            }
            
            const selectSaida = card.querySelector(`select[name="porta_saida_${andar}"]`);
            if (selectSaida && saidaTerreo) {
                selectSaida.value = saidaTerreo;
            }
            
            const selectAbertura = card.querySelector(`select[name="porta_abertura_${andar}"]`);
            if (selectAbertura && aberturaTerreo) {
                selectAbertura.value = aberturaTerreo;
            }
            
            const selectFolhas = card.querySelector(`select[name="porta_folhas_${andar}"]`);
            if (selectFolhas && folhasTerreo) {
                selectFolhas.value = folhasTerreo;
            }
            
            const inputLargura = card.querySelector(`input[name="porta_largura_${andar}"]`);
            if (inputLargura && larguraTerreo) {
                inputLargura.value = larguraTerreo;
            }
            
            const inputAltura = card.querySelector(`input[name="porta_altura_${andar}"]`);
            if (inputAltura && alturaTerreo) {
                inputAltura.value = alturaTerreo;
            }
            
            pavimentosAtualizados++;
        });
        
        toggleFolhasPortasIndividuais();
        
        const btn = document.getElementById('replicar-terreo-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Replicado!';
        btn.classList.remove('btn-light');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-light');
        }, 2000);
    }
    
    // === EVENT LISTENERS ===
    
    if (pisoCabineSelect) {
        pisoCabineSelect.addEventListener('change', togglePisoCabine);
    }
    
    if (modeloPortaCabineSelect) {
        modeloPortaCabineSelect.addEventListener('change', togglePortaCabine);
    }
    
    if (replicarTerreoBtn) {
        replicarTerreoBtn.addEventListener('click', replicarConfiguracao);
    }
    
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('modelo-porta-select')) {
            toggleFolhasPortasIndividuais();
        }
    });
    
    // === CONVERSÃO DE VÍRGULA PARA PONTO NO SUBMIT ===
    if (form) {
        form.addEventListener('submit', function(e) {
            // Converter vírgulas para pontos nos campos decimais principais
            const camposDecimais = [
                '{{ form.altura_cabine.id_for_label }}',
                '{{ form.largura_porta_cabine.id_for_label }}',
                '{{ form.altura_porta_cabine.id_for_label }}'
            ];
            
            camposDecimais.forEach(id => {
                const campo = document.getElementById(id);
                if (campo && campo.value) {
                    campo.value = campo.value.replace(',', '.');
                }
            });
            
            // Converter também nos campos das portas individuais
            document.querySelectorAll('input[name^="porta_largura_"], input[name^="porta_altura_"]').forEach(campo => {
                if (campo.value) {
                    campo.value = campo.value.replace(',', '.');
                }
            });
            
            // Validação mínima
            if (modeloPortaCabineSelect && modeloPortaCabineSelect.value === 'Automática') {
                const folhasCabine = document.getElementById('{{ form.folhas_porta_cabine.id_for_label }}');
                if (folhasCabine && !folhasCabine.value) {
                    e.preventDefault();
                    alert('Para porta automática da cabine, selecione o número de folhas.');
                    folhasCabine.focus();
                    return false;
                }
            }
        });
    }
    
    // === INICIALIZAÇÃO ===
    
    formatarCamposDecimais();
    togglePisoCabine();
    togglePortaCabine();
    toggleFolhasPortasIndividuais();
});
</script>
{% endblock %}