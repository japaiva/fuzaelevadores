{% extends 'vendedor/base_vendedor.html' %}

{% block title %}{% if is_edit %}Editar Vistoria{% else %}Nova Vistoria{% endif %} - {{ proposta.numero }} | Portal do Vendedor{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        <i class="fas fa-plus-circle me-2"></i>Nova Vistoria - {{ proposta.numero }}
      </h5>
      <a href="{% url 'vendedor:vistoria_proposta_detail' proposta.pk %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
    
    <div class="card-body">
      <!-- Informações da Proposta - AJUSTADO com duas linhas -->
      <div class="card shadow-sm border-primary mb-4">
        <div class="card-header bg-primary text-white">
          <h6 class="card-title mb-0">Informações da Proposta</h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-2-4">
              <div class="campo-info">
                <div class="campo-label text-muted">Número:</div>
                <div class="campo-valor"><strong>{{ proposta.numero }}</strong></div>
              </div>
            </div>
            <div class="col-md-2-4">
              <div class="campo-info">
                <div class="campo-label text-muted">Cliente:</div>
                <div class="campo-valor"><strong>{{ proposta.cliente.nome }}</strong></div>
              </div>
            </div>
            <div class="col-md-2-4">
              <div class="campo-info">
                <div class="campo-label text-muted">Projeto:</div>
                <div class="campo-valor"><strong>{{ proposta.nome_projeto }}</strong></div>
              </div>
            </div>
            <div class="col-md-2-4">
              <div class="campo-info">
                <div class="campo-label text-muted">Status Obra:</div>
                <div class="campo-valor">
                  {% if proposta.status_obra %}
                    <span class="badge {{ proposta.status_obra_badge_class }}">{{ proposta.get_status_obra_display }}</span>
                  {% else %}
                    <span class="badge bg-secondary">Aguardando</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-md-2-4">
              <div class="campo-info">
                <div class="campo-label text-muted">Próxima Vistoria:</div>
                <div class="campo-valor">
                  {% if proposta.data_proxima_vistoria %}
                    <strong class="{% if proposta.proxima_vistoria_vencida %}text-danger{% else %}text-primary{% endif %}">
                      {{ proposta.data_proxima_vistoria|date:"d/m/Y" }}
                    </strong>
                  {% else %}
                    <span class="text-muted">Não agendada</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <form method="post" id="vistoriaForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
              <p class="mb-0">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
        
        <!-- Dados da Vistoria (Expandido) -->
        <div class="card shadow-sm border-warning mb-4">
          <div class="card-header bg-warning text-dark">
            <h6 class="card-title mb-0">Dados da Vistoria</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label" for="{{ form.data_realizada.id_for_label }}">
                  Data da Vistoria*
                </label>
                {{ form.data_realizada }}
                {% if form.data_realizada.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.data_realizada.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-3">
                <label class="form-label" for="{{ form.tipo_vistoria.id_for_label }}">
                  Tipo de Vistoria*
                </label>
                {{ form.tipo_vistoria }}
                
                <!-- NOVO: Alerta para medição -->
                <div class="alert alert-info alert-sm mt-2" id="alerta-medicao" style="display:none; font-size:0.8rem;">
                  <i class="fas fa-info-circle me-1"></i>
                  <strong>Medição Inicial:</strong> Será redirecionado para formulário especializado com campos técnicos.
                </div>
                
                {% if form.tipo_vistoria.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.tipo_vistoria.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-3">
                <label class="form-label" for="status_obra_novo">
                  Novo Status da Obra
                </label>
                <select class="form-select" id="status_obra_novo" name="status_obra_novo">
                  <option value="">Manter status atual</option>
                  <option value="medicao_ok">Medição OK</option>
                  <option value="em_vistoria">Em Vistoria</option>
                  <option value="obra_ok">Obra OK</option>
                  <option value="projeto_entregue">Projeto Entregue</option>
                </select>
              </div>
              
              <div class="col-md-3">
                <label class="form-label" for="previsao_entrega_obra">
                  Previsão Entrega Obra
                </label>
                <input type="date" class="form-control" id="previsao_entrega_obra" name="previsao_entrega_obra" 
                       value="{{ proposta.previsao_conclusao_obra|date:'Y-m-d' }}">
              </div>
              
              <!-- Observações e Recomendações na mesma seção -->
              <div class="col-md-6">
                <label class="form-label" for="{{ form.observacoes.id_for_label }}">
                  Observações
                </label>
                <textarea class="form-control" id="{{ form.observacoes.id_for_label }}" name="observacoes" rows="4"></textarea>
                {% if form.observacoes.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-6">
                <label class="form-label" for="{{ form.recomendacoes.id_for_label }}">
                  Recomendações
                </label>
                <textarea class="form-control" id="{{ form.recomendacoes.id_for_label }}" name="recomendacoes" rows="4"></textarea>
                {% if form.recomendacoes.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.recomendacoes.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Campo de mudanças automático -->
              <div class="col-12">
                <label class="form-label" for="mudancas_automaticas">
                  Alterações Realizadas
                </label>
                <textarea class="form-control" id="mudancas_automaticas" name="mudancas_automaticas" rows="3" readonly 
                          style="background-color: #f8f9fa; border-color: #e9ecef;"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Próxima Vistoria -->
        <div class="card shadow-sm border-success mb-4">
          <div class="card-header bg-success text-white">
            <h6 class="card-title mb-0">Próxima Vistoria</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="{{ form.proxima_vistoria_sugerida.id_for_label }}">
                  Data da Próxima Vistoria
                </label>
                {{ form.proxima_vistoria_sugerida }}
                {% if form.proxima_vistoria_sugerida.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.proxima_vistoria_sugerida.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'vendedor:vistoria_proposta_detail' proposta.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-times me-1"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i> Registrar Vistoria
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('vistoriaForm');
    const dataRealizadaInput = document.getElementById('{{ form.data_realizada.id_for_label }}');
    const tipoVistoriaSelect = document.getElementById('{{ form.tipo_vistoria.id_for_label }}');
    const statusObraSelect = document.getElementById('status_obra_novo');
    const proximaVistoriaInput = document.getElementById('{{ form.proxima_vistoria_sugerida.id_for_label }}');
    const previsaoEntregaInput = document.getElementById('previsao_entrega_obra');
    const mudancasTextarea = document.getElementById('mudancas_automaticas');
    const alertaMedicao = document.getElementById('alerta-medicao');
    
    // Status e previsão originais para comparação
    const statusOriginal = '{{ proposta.status_obra|default:"Aguardando" }}';
    const previsaoOriginal = '{{ proposta.previsao_conclusao_obra|date:"d/m/Y"|default:"Não definida" }}';
    
    // FUNÇÃO PRINCIPAL: Verificar e redirecionar para medição
    function verificarRedirecionamentoMedicao() {
        if (tipoVistoriaSelect.value === 'medicao') {
            const confirmacao = confirm(
                'Medição inicial requer formulário especializado com campos técnicos de medição:\n\n' +
                '• Medições do fosso, poço e cintas\n' +
                '• Vãos de porta por pavimento\n' +
                '• Casa de máquina\n\n' +
                'Deseja ir para o formulário de medição agora?'
            );
            
            if (confirmacao) {
                // Redirecionar para formulário de medição
                window.location.href = `{% url 'vendedor:vistoria_medicao_create' proposta.pk %}`;
                return true; // Indica que foi redirecionado
            } else {
                // Voltar para acompanhamento se cancelou
                tipoVistoriaSelect.value = 'acompanhamento';
                mostrarOcultarAlertaMedicao();
                sugerirProximaVistoria();
                sugerirStatus();
                atualizarMudancas();
            }
        }
        return false; // Não foi redirecionado
    }
    
    // Função para mostrar/ocultar alerta de medição
    function mostrarOcultarAlertaMedicao() {
        if (alertaMedicao) {
            if (tipoVistoriaSelect.value === 'medicao') {
                alertaMedicao.style.display = 'block';
            } else {
                alertaMedicao.style.display = 'none';
            }
        }
    }
    
    // Função para atualizar o campo de mudanças - CORRIGIDA para não somar um dia
    function atualizarMudancas() {
        let mudancas = [];
        
        // Verificar mudança de status
        const novoStatus = statusObraSelect.value;
        if (novoStatus && novoStatus !== '{{ proposta.status_obra }}') {
            const statusDisplay = statusObraSelect.options[statusObraSelect.selectedIndex].text;
            mudancas.push(`Status da obra: ${statusOriginal} → ${statusDisplay}`);
        }
        
        // Verificar mudança de previsão - CORRIGIDO
        const novaPrevisao = previsaoEntregaInput.value;
        if (novaPrevisao) {
            // Criar data sem conversão UTC para evitar problema de fuso horário
            const [ano, mes, dia] = novaPrevisao.split('-');
            const dataObj = new Date(ano, mes - 1, dia); // mes-1 porque Date usa 0-11
            const previsaoFormatada = dataObj.toLocaleDateString('pt-BR');
            
            if (previsaoFormatada !== previsaoOriginal) {
                mudancas.push(`Previsão de entrega: ${previsaoOriginal} → ${previsaoFormatada}`);
            }
        }
        
        mudancasTextarea.value = mudancas.length > 0 ? mudancas.join('\n') : '';
    }
    
    // Função para sugerir próxima vistoria baseada no tipo - CORRIGIDA
    function sugerirProximaVistoria() {
        const tipo = tipoVistoriaSelect.value;
        const dataAtual = dataRealizadaInput.value;
        
        if (!dataAtual) return;
        
        // Criar data sem conversão UTC
        const [ano, mes, dia] = dataAtual.split('-');
        const dataBase = new Date(ano, mes - 1, dia);
        let diasParaProxima;
        
        switch(tipo) {
            case 'medicao':
                diasParaProxima = 15;
                break;
            case 'acompanhamento':
                diasParaProxima = 14;
                break;
            case 'obra_pronta':
            case 'entrega':
                diasParaProxima = 0;
                break;
            default:
                diasParaProxima = 15;
        }
        
        if (diasParaProxima > 0) {
            const proximaData = new Date(dataBase);
            proximaData.setDate(dataBase.getDate() + diasParaProxima);
            
            const anoProx = proximaData.getFullYear();
            const mesProx = String(proximaData.getMonth() + 1).padStart(2, '0');
            const diaProx = String(proximaData.getDate()).padStart(2, '0');
            
            proximaVistoriaInput.value = `${anoProx}-${mesProx}-${diaProx}`;
        } else {
            proximaVistoriaInput.value = '';
        }
    }
    
    // Função para sugerir status baseado no tipo de vistoria
    function sugerirStatus() {
        const tipo = tipoVistoriaSelect.value;
        
        if (statusObraSelect.value) return; // Não sobrescrever se usuário já escolheu
        
        switch(tipo) {
            case 'medicao':
                statusObraSelect.value = 'medicao_ok';
                break;
            case 'acompanhamento':
                statusObraSelect.value = 'em_vistoria';
                break;
            case 'obra_pronta':
                statusObraSelect.value = 'obra_ok';
                break;
            case 'entrega':
                statusObraSelect.value = 'projeto_entregue';
                break;
        }
        
        atualizarMudancas();
    }
    
    // EVENT LISTENERS
    if (tipoVistoriaSelect) {
        tipoVistoriaSelect.addEventListener('change', function() {
            mostrarOcultarAlertaMedicao();
            
            // Se não redirecionou, executar outras funções
            if (!verificarRedirecionamentoMedicao()) {
                sugerirProximaVistoria();
                sugerirStatus();
            }
        });
        
        // Verificar no carregamento da página se já está como medição
        if (tipoVistoriaSelect.value === 'medicao') {
            setTimeout(function() {
                mostrarOcultarAlertaMedicao();
                verificarRedirecionamentoMedicao();
            }, 100);
        }
    }
    
    if (dataRealizadaInput) {
        dataRealizadaInput.addEventListener('change', sugerirProximaVistoria);
    }
    
    if (statusObraSelect) {
        statusObraSelect.addEventListener('change', atualizarMudancas);
    }
    
    if (previsaoEntregaInput) {
        previsaoEntregaInput.addEventListener('change', atualizarMudancas);
    }
    
    // INTERCEPTAR SUBMIT PARA MEDIÇÃO
    if (form) {
        form.addEventListener('submit', function(e) {
            const tipoSelecionado = tipoVistoriaSelect.value;
            
            // Bloquear submit se for medição
            if (tipoSelecionado === 'medicao') {
                e.preventDefault();
                alert('Para medição inicial, use o formulário especializado.\nRedirecionando agora...');
                window.location.href = `{% url 'vendedor:vistoria_medicao_create' proposta.pk %}`;
                return false;
            }
            
            // Validação normal para outros tipos
            const dataRealizada = dataRealizadaInput.value;
            
            if (!dataRealizada) {
                e.preventDefault();
                alert('A data da vistoria é obrigatória.');
                dataRealizadaInput.focus();
                return;
            }
            
            const hoje = new Date();
            const [ano, mes, dia] = dataRealizada.split('-');
            const vistoria = new Date(ano, mes - 1, dia);
            const diasDiferenca = Math.ceil((hoje - vistoria) / (1000 * 60 * 60 * 24));
            
            if (diasDiferenca > 30) {
                e.preventDefault();
                alert('A data da vistoria não pode ser muito antiga (máximo 30 dias).');
                dataRealizadaInput.focus();
                return;
            }
            
            console.log('✅ Formulário validado - enviando...');
        });
    }
    
    // Inicializar sugestões
    mostrarOcultarAlertaMedicao();
    sugerirProximaVistoria();
    sugerirStatus();
    atualizarMudancas();
    
    console.log('✅ Formulário de nova vistoria inicializado com redirecionamento automático para medição');
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.container-fluid {
    max-width: 1400px;
}

.card-body {
    padding: 1.5rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

#mudancas_automaticas {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #495057;
}

/* NOVO: Estilos para alerta de medição */
.alert-sm {
    padding: 0.5rem;
    border-radius: 0.25rem;
}

#alerta-medicao {
    border-color: #0dcaf0;
    background-color: rgba(13, 202, 240, 0.1);
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ESTILO PARA CAMPOS COM DUAS LINHAS */
.campo-info {
    margin-bottom: 1rem;
}

.campo-label {
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.campo-valor {
    font-size: 1rem;
    min-height: 1.5rem;
}

/* Grid customizado para 5 colunas */
.col-md-2-4 {
    flex: 0 0 auto;
    width: 20%;
}

@media (max-width: 768px) {
    .col-md-2-4 {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .container-fluid {
        padding: 0.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
}
</style>
{% endblock %}