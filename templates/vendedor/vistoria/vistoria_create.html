{% extends 'vendedor/base_vendedor.html' %}

{% block title %}Nova Vistoria - {{ proposta.numero }} | Portal do Vendedor{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        <i class="fas fa-plus-circle me-2"></i>Nova Vistoria - {{ proposta.numero }}
      </h5>
      <a href="{% url 'vendedor:vistoria_proposta_detail' proposta.pk %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Voltar
      </a>
    </div>
    
    <div class="card-body">
      <!-- Informações da Proposta -->
      <div class="card shadow-sm border-primary mb-4">
        <div class="card-header bg-primary text-white">
          <h6 class="card-title mb-0">Informações da Proposta</h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="d-flex justify-content-between">
                <span class="text-muted">Número:</span>
                <strong>{{ proposta.numero }}</strong>
              </div>
            </div>
            <div class="col-md-3">
              <div class="d-flex justify-content-between">
                <span class="text-muted">Cliente:</span>
                <strong>{{ proposta.cliente.nome }}</strong>
              </div>
            </div>
            <div class="col-md-3">
              <div class="d-flex justify-content-between">
                <span class="text-muted">Projeto:</span>
                <strong>{{ proposta.nome_projeto }}</strong>
              </div>
            </div>
            <div class="col-md-3">
              <div class="d-flex justify-content-between">
                <span class="text-muted">Status Obra:</span>
                {% if proposta.status_obra %}
                  <span class="badge {{ proposta.status_obra_badge_class }}">{{ proposta.get_status_obra_display }}</span>
                {% else %}
                  <span class="badge bg-secondary">Aguardando</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <form method="post" id="vistoriaForm">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
              <p class="mb-0">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
        
        <!-- Dados da Vistoria (Expandido) -->
        <div class="card shadow-sm border-warning mb-4">
          <div class="card-header bg-warning text-dark">
            <h6 class="card-title mb-0">Dados da Vistoria</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label" for="{{ form.data_agendada.id_for_label }}">
                  Data da Vistoria*
                </label>
                {{ form.data_agendada }}
                {% if form.data_agendada.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.data_agendada.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-3">
                <label class="form-label" for="{{ form.tipo_vistoria.id_for_label }}">
                  Tipo de Vistoria*
                </label>
                {{ form.tipo_vistoria }}
                {% if form.tipo_vistoria.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.tipo_vistoria.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-3">
                <label class="form-label" for="{{ form.status_obra_novo.id_for_label }}">
                  Novo Status da Obra
                </label>
                <select class="form-select" id="{{ form.status_obra_novo.id_for_label }}" name="status_obra_novo">
                  <option value="">Manter status atual</option>
                  <option value="medicao_ok">Medição OK</option>
                  <option value="em_vistoria">Em Vistoria</option>
                  <option value="obra_ok">Obra OK</option>
                  <option value="projeto_entregue">Projeto Entregue</option>
                </select>
                {% if form.status_obra_novo.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.status_obra_novo.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-3">
                <label class="form-label" for="previsao_entrega_obra">
                  Previsão Entrega Obra
                </label>
                <input type="date" class="form-control" id="previsao_entrega_obra" name="previsao_entrega_obra" 
                       value="{{ proposta.previsao_conclusao_obra|date:'Y-m-d' }}">
              </div>
              
              <!-- Observações e Recomendações na mesma seção -->
              <div class="col-md-6">
                <label class="form-label" for="{{ form.observacoes.id_for_label }}">
                  Observações
                </label>
                <textarea class="form-control" id="{{ form.observacoes.id_for_label }}" name="observacoes" rows="4"></textarea>
                {% if form.observacoes.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.observacoes.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-6">
                <label class="form-label" for="{{ form.recomendacoes.id_for_label }}">
                  Recomendações
                </label>
                <textarea class="form-control" id="{{ form.recomendacoes.id_for_label }}" name="recomendacoes" rows="4"></textarea>
                {% if form.recomendacoes.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.recomendacoes.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Campo de mudanças automático -->
              <div class="col-12">
                <label class="form-label" for="mudancas_automaticas">
                  Alterações Realizadas
                </label>
                <textarea class="form-control" id="mudancas_automaticas" name="mudancas_automaticas" rows="3" readonly 
                          style="background-color: #f8f9fa; border-color: #e9ecef;"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Próxima Vistoria -->
        <div class="card shadow-sm border-success mb-4">
          <div class="card-header bg-success text-white">
            <h6 class="card-title mb-0">Próxima Vistoria</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="{{ form.proxima_vistoria_sugerida.id_for_label }}">
                  Data da Próxima Vistoria
                </label>
                {{ form.proxima_vistoria_sugerida }}
                {% if form.proxima_vistoria_sugerida.errors %}
                  <div class="text-danger small mt-1">
                    {% for error in form.proxima_vistoria_sugerida.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <div class="col-md-6">
                <div class="mt-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="marcarComoRealizada">
                    <label class="form-check-label" for="marcarComoRealizada">
                      <strong>Marcar como realizada agora</strong>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <a href="{% url 'vendedor:vistoria_proposta_detail' proposta.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-times me-1"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i> Registrar Vistoria
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('vistoriaForm');
    const dataAgendadaInput = document.getElementById('{{ form.data_agendada.id_for_label }}');
    const tipoVistoriaSelect = document.getElementById('{{ form.tipo_vistoria.id_for_label }}');
    const statusObraSelect = document.getElementById('{{ form.status_obra_novo.id_for_label }}');
    const proximaVistoriaInput = document.getElementById('{{ form.proxima_vistoria_sugerida.id_for_label }}');
    const marcarRealizadaCheck = document.getElementById('marcarComoRealizada');
    const previsaoEntregaInput = document.getElementById('previsao_entrega_obra');
    const mudancasTextarea = document.getElementById('mudancas_automaticas');
    
    // Status e previsão originais para comparação
    const statusOriginal = '{{ proposta.status_obra|default:"Aguardando" }}';
    const previsaoOriginal = '{{ proposta.previsao_conclusao_obra|date:"d/m/Y"|default:"Não definida" }}';
    
    // Função para atualizar o campo de mudanças
    function atualizarMudancas() {
        let mudancas = [];
        
        // Verificar mudança de status
        const novoStatus = statusObraSelect.value;
        if (novoStatus && novoStatus !== '{{ proposta.status_obra }}') {
            const statusDisplay = statusObraSelect.options[statusObraSelect.selectedIndex].text;
            mudancas.push(`Status da obra: ${statusOriginal} → ${statusDisplay}`);
        }
        
        // Verificar mudança de previsão
        const novaPrevisao = previsaoEntregaInput.value;
        if (novaPrevisao) {
            const previsaoFormatada = new Date(novaPrevisao).toLocaleDateString('pt-BR');
            if (previsaoFormatada !== previsaoOriginal) {
                mudancas.push(`Previsão de entrega: ${previsaoOriginal} → ${previsaoFormatada}`);
            }
        }
        
        mudancasTextarea.value = mudancas.length > 0 ? mudancas.join('\n') : '';
    }
    
    // Função para sugerir próxima vistoria baseada no tipo
    function sugerirProximaVistoria() {
        const tipo = tipoVistoriaSelect.value;
        const dataAtual = dataAgendadaInput.value;
        
        if (!dataAtual) return;
        
        const dataBase = new Date(dataAtual);
        let diasParaProxima;
        
        switch(tipo) {
            case 'medicao':
                diasParaProxima = 15;
                break;
            case 'acompanhamento':
                diasParaProxima = 14;
                break;
            case 'obra_pronta':
            case 'entrega':
                diasParaProxima = 0;
                break;
            default:
                diasParaProxima = 15;
        }
        
        if (diasParaProxima > 0) {
            const proximaData = new Date(dataBase);
            proximaData.setDate(dataBase.getDate() + diasParaProxima);
            
            const ano = proximaData.getFullYear();
            const mes = String(proximaData.getMonth() + 1).padStart(2, '0');
            const dia = String(proximaData.getDate()).padStart(2, '0');
            
            proximaVistoriaInput.value = `${ano}-${mes}-${dia}`;
        } else {
            proximaVistoriaInput.value = '';
        }
    }
    
    // Função para sugerir status baseado no tipo de vistoria
    function sugerirStatus() {
        const tipo = tipoVistoriaSelect.value;
        
        if (statusObraSelect.value) return;
        
        switch(tipo) {
            case 'medicao':
                statusObraSelect.value = 'medicao_ok';
                break;
            case 'acompanhamento':
                statusObraSelect.value = 'em_vistoria';
                break;
            case 'obra_pronta':
                statusObraSelect.value = 'obra_ok';
                break;
            case 'entrega':
                statusObraSelect.value = 'projeto_entregue';
                break;
        }
        
        atualizarMudancas();
    }
    
    // Event listeners
    if (tipoVistoriaSelect) {
        tipoVistoriaSelect.addEventListener('change', function() {
            sugerirProximaVistoria();
            sugerirStatus();
        });
    }
    
    if (dataAgendadaInput) {
        dataAgendadaInput.addEventListener('change', sugerirProximaVistoria);
    }
    
    if (statusObraSelect) {
        statusObraSelect.addEventListener('change', atualizarMudancas);
    }
    
    if (previsaoEntregaInput) {
        previsaoEntregaInput.addEventListener('change', atualizarMudancas);
    }
    
    // Marcar como realizada
    if (marcarRealizadaCheck) {
        marcarRealizadaCheck.addEventListener('change', function() {
            if (this.checked) {
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                
                dataAgendadaInput.value = `${ano}-${mes}-${dia}`;
                
                let hiddenInput = document.getElementById('marcar_realizada_hidden');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = 'marcar_realizada_hidden';
                    hiddenInput.name = 'marcar_realizada';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = 'true';
                
                sugerirProximaVistoria();
                sugerirStatus();
            } else {
                const hiddenInput = document.getElementById('marcar_realizada_hidden');
                if (hiddenInput) {
                    hiddenInput.remove();
                }
            }
        });
    }
    
    // Validação do formulário
    if (form) {
        form.addEventListener('submit', function(e) {
            const dataAgendada = dataAgendadaInput.value;
            
            if (!dataAgendada) {
                e.preventDefault();
                alert('A data da vistoria é obrigatória.');
                dataAgendadaInput.focus();
                return;
            }
            
            const hoje = new Date();
            const vistoria = new Date(dataAgendada);
            const diasDiferenca = Math.ceil((hoje - vistoria) / (1000 * 60 * 60 * 24));
            
            if (diasDiferenca > 30) {
                e.preventDefault();
                alert('A data da vistoria não pode ser muito antiga (máximo 30 dias).');
                dataAgendadaInput.focus();
                return;
            }
            
            console.log('✅ Formulário validado - enviando...');
        });
    }
    
    // Inicializar sugestões
    sugerirProximaVistoria();
    sugerirStatus();
    atualizarMudancas();
    
    console.log('✅ Formulário de nova vistoria inicializado');
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.container-fluid {
    max-width: 1400px;
}

.card-body {
    padding: 1.5rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

#mudancas_automaticas {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    color: #495057;
}

.btn-group .btn {
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-top-left-radius: 0.375rem;
    border-bottom-left-radius: 0.375rem;
}

.btn-group .btn:last-child {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

@media (max-width: 768px) {
    .container-fluid {
        padding: 0.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}